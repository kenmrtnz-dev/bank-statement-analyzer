const St=document.getElementById("uploadArea"),Pi=document.getElementById("browseButton"),Te=document.getElementById("fileInput"),Xr=document.getElementById("fileInfo"),Ti=document.getElementById("fileName"),$i=document.getElementById("fileSize"),Mi=document.getElementById("removeFile"),Ii=document.getElementById("progressFill"),Ni=document.getElementById("progressPercent"),Ri=document.getElementById("progressLabel"),Ai=document.getElementById("progressStep"),tt=document.getElementById("progressElapsed"),or=document.getElementById("progressModel"),sr=document.getElementById("analyzerStatus"),lr=document.getElementById("progressAnalyzerRow"),cr=document.getElementById("analyzerModel"),dr=document.getElementById("analyzerProfile"),ur=document.getElementById("analyzerReason"),Ln=document.getElementById("downloadCSV"),Bn=document.getElementById("exportExcelBtn"),je=document.getElementById("finishReviewBtn"),Fi=document.getElementById("viewDetails"),$e=document.getElementById("finishSave"),de=document.querySelector(".table-body"),Jt=document.getElementById("totalTransactions"),Qt=document.getElementById("totalDebitTransactions"),en=document.getElementById("totalCreditTransactions"),tn=document.getElementById("endingBalance"),ue=document.getElementById("accountNameSummary"),fe=document.getElementById("accountNumberSummary"),p=document.getElementById("previewImage"),I=document.getElementById("previewCanvas"),xa=document.getElementById("prevPageBtn"),Ca=document.getElementById("nextPageBtn"),Qe=document.getElementById("ocrToolsToggleBtn"),Dt=document.getElementById("flattenModeBtn"),kn=document.getElementById("applyFlattenBtn"),Pn=document.getElementById("resetFlattenBtn"),fr=document.getElementById("resetViewBtn"),gr=document.getElementById("zoomOutBtn"),mr=document.getElementById("zoomInBtn"),Ot=document.getElementById("addHorizontalGuideBtn"),pr=document.getElementById("clearGuideLinesBtn"),Tn=document.getElementById("guideUndoBtn"),$n=document.getElementById("guideRedoBtn"),nt=document.getElementById("runSectionOcrBtn"),Mn=Array.from(document.querySelectorAll(".preview-image-tool-btn")),vn=document.getElementById("guideSectionsInfo"),ya=document.getElementById("sectionOcrResult"),S=document.getElementById("previewColumnsRuler"),z=document.getElementById("previewRowsRuler"),Ea=document.getElementById("pageIndicator"),ke=document.getElementById("pageSelect"),x=document.querySelector(".preview-canvas-wrap"),xt=document.querySelector(".preview-panel"),yt=document.querySelector(".table-panel"),bt=document.querySelector(".transactions-table"),hr=document.querySelector(".transactions-table .table-header"),yr=document.getElementById("zoomLevel"),br=document.querySelector(".results-section"),It=document.getElementById("previewPageSavedMark"),wr=document.getElementById("summaryLockedNote"),In=document.querySelector(".summary-card"),ht=document.getElementById("ocrToggle"),vr=document.getElementById("modeToggleText"),_r=document.getElementById("legacyMain"),Sr=document.getElementById("authEmail"),xr=document.getElementById("authPassword"),Nn=document.getElementById("authLoginBtn"),Rn=document.getElementById("authLogoutBtn"),Cr=document.getElementById("authUserBadge"),Er=document.getElementById("agentWorkflowPanel"),Lr=document.getElementById("evaluatorWorkflowPanel"),we=document.getElementById("agentFileInput"),Br=document.getElementById("agentBrowseButton"),Ze=document.getElementById("agentDropZone"),Ut=document.getElementById("agentSelectedFiles"),An=document.getElementById("agentSearchInput"),kr=document.getElementById("agentUploadProgressWrap"),Pr=document.getElementById("agentUploadProgressFill"),Tr=document.getElementById("agentUploadProgressLabel"),$r=document.getElementById("agentUploadProgressPercent"),ee=document.getElementById("agentBorrowerName"),Nt=document.getElementById("agentLeadReference"),Me=document.getElementById("agentSubmitBtn"),Mr=document.getElementById("agentRefreshBtn"),Ct=document.getElementById("agentSubmissionList"),Ir=document.getElementById("evaluatorRefreshBtn"),Fn=document.getElementById("evaluatorSearchInput"),jt=document.getElementById("evaluatorCombineBtn"),at=document.getElementById("evaluatorSubmissionList");document.getElementById("evaluatorActionBar");document.getElementById("evaluatorStartBtn");document.getElementById("evaluatorOpenBtn");document.getElementById("evaluatorSaveBtn");document.getElementById("evaluatorAnalyzeBtn");document.getElementById("evaluatorReportBtn");document.getElementById("evaluatorReadyBtn");const V=document.body&&document.body.dataset&&document.body.dataset.pageRole||"all";let rt=null,b=null,h=[],y=[],wt={},se={},Ne={},he={},L=0,re=null,ct=!1,it=!1,nn=1,$=!1,J=[],ie=!1,He=!1,an={},rn=0,Ie=null;const La=["date","description","debit","credit","balance"],Oa=1,Ua=3.5,Yr=.12;let W=1,ve=0,Ee=0,on=!1,Nr=0,Rr=0,Ar=0,Fr=0;const Ht=new Set,Et=new Map;let Q=localStorage.getItem("auth_token")||"",v=localStorage.getItem("auth_role")||"",Ba=localStorage.getItem("auth_email")||"",m=null,j=[],ze={total_pages:0,parsed_pages:0},Le=!1,me="",We="pending",Wt=null,ge=!1,Lt=0,pt=null,Gt=null,xn=null,Kr=!1,ka=[],le=1;const _n=15;let sn=[],ce=1;const Sn=15;let Re=new Set,Pa=!1,Ta=!1,$a="",Cn=0,Ma="",zn=0,Dn="queued",On=!1;const Un=.006,ja=100,zi=700,De=.08,et=.01,ba=40,Di=[{key:"date",label:"Date",width:.16},{key:"description",label:"Description",width:.34},{key:"debit",label:"Debit",width:.16},{key:"credit",label:"Credit",width:.16},{key:"balance",label:"Balance",width:.18}];let qt={},Xt={},ot={},A={sourceKey:"",targetKey:""},Y=null,H="",te=null,ea={},K="none",ta={},Yt=!1,ne=null,Oe=0,dn=!1,vt="text",na=!1,Se=null;function Oi(){return Se&&document.body.contains(Se)||(Se=document.getElementById("appToastContainer"),Se||(Se=document.createElement("div"),Se.id="appToastContainer",Se.className="app-toast-container",document.body.appendChild(Se))),Se}function Ui(e){const t=String(e||"").toLowerCase();return t?t.includes("failed")||t.includes("error")||t.includes("forbidden")||t.includes("timeout")?"error":t.includes("warning")||t.includes("stalled")||t.includes("select")||t.includes("blocked")?"warning":t.includes("done")||t.includes("saved")||t.includes("completed")||t.includes("enabled")||t.includes("submitted")?"success":"info":"info"}function zr(e,t="info",n=3200){const a=Oi(),r=document.createElement("div");r.className=`app-toast app-toast-${t}`,r.setAttribute("role","status");const i=document.createElement("div");i.className="app-toast-text",i.textContent=String(e||""),r.appendChild(i);const o=document.createElement("button");o.className="app-toast-close",o.type="button",o.setAttribute("aria-label","Dismiss notification"),o.textContent="×",o.addEventListener("click",()=>{r.classList.add("closing"),setTimeout(()=>r.remove(),140)}),r.appendChild(o),a.appendChild(r),requestAnimationFrame(()=>r.classList.add("show")),n>0&&setTimeout(()=>{r.isConnected&&(r.classList.add("closing"),setTimeout(()=>r.remove(),140))},n)}if(typeof window<"u"){const e=window.alert?window.alert.bind(window):null;window.__nativeAlert=e,window.showToast=zr,window.alert=t=>{zr(t,Ui(t))}}(V==="agent"||V==="credit_evaluator")&&(!Q||!v)&&(window.location.href="/login");V==="agent"&&v&&v!=="agent"&&(v==="credit_evaluator"?window.location.href="/evaluator":v==="admin"?window.location.href="/admin":window.location.href="/login");V==="credit_evaluator"&&v&&v!=="credit_evaluator"&&(v==="agent"?window.location.href="/agent":v==="admin"?window.location.href="/admin":window.location.href="/login");function aa(){return ht&&ht.checked?"ocr":"text"}function ji(e){return String(e||"").trim().toLowerCase()==="ocr"?"ocr":"text"}function jn(){return vt==="ocr"||na}function D(){return!!(v==="credit_evaluator"&&m)&&!jn()}function Ha(){if(!Qe)return;const e=jn();Qe.textContent=e?"OCR":"TEXT",Qe.classList.toggle("is-active",e),Qe.setAttribute("aria-label",e?"OCR tools enabled":"OCR tools disabled"),Qe.title=e?"OCR tools enabled":"OCR tools disabled"}function Hi(e){const t=ji(e||vt);t!==vt&&(na=t==="ocr"),vt=t,D()&&(K="none",$&&($=!1,J=[])),Ha(),q(),N()}function Vr(){vr&&(vr.textContent=aa().toUpperCase())}Pi.addEventListener("click",e=>{e.stopPropagation(),is()});if(ht){ht.addEventListener("click",t=>t.stopPropagation()),ht.addEventListener("change",Vr);const e=ht.closest(".mode-toggle");e&&e.addEventListener("click",t=>t.stopPropagation())}Vr();N();function ra(e){_r&&(_r.style.display=e?"":"none")}function Wa(){if(!p||!p.naturalWidth||!p.naturalHeight)return;const e=Math.max(1,Number(p.naturalWidth)),t=Math.max(1,Number(p.naturalHeight)),n=`${e} / ${t}`;if(xt&&xt.style.setProperty("--preview-aspect-ratio",n),x){x.style.setProperty("aspect-ratio",n);const a=x.clientWidth||x.getBoundingClientRect().width||0;if(a>0){const r=Math.max(120,Math.round(a*t/e));x.style.height=`${r}px`}}requestAnimationFrame(Hn)}function Wi(){xt&&(xt.style.removeProperty("--preview-aspect-ratio"),x&&(x.style.removeProperty("aspect-ratio"),x.style.removeProperty("height")),Ia())}function Ia(){yt&&(yt.style.removeProperty("height"),yt.style.removeProperty("max-height")),bt&&(bt.style.removeProperty("height"),bt.style.removeProperty("max-height")),de&&(de.style.removeProperty("height"),de.style.removeProperty("max-height"),de.style.removeProperty("overflow-y"))}function Hn(){if(!yt||!bt||!de||!xt||!p||!p.naturalWidth){Ia();return}const e=Math.round(xt.getBoundingClientRect().height||0);if(!Number.isFinite(e)||e<=0){Ia();return}yt.style.height=`${e}px`,yt.style.maxHeight=`${e}px`,bt.style.height=`${e}px`,bt.style.maxHeight=`${e}px`;const t=Math.round(hr&&hr.getBoundingClientRect().height||0),n=Math.max(80,e-t-2);de.style.height=`${n}px`,de.style.maxHeight=`${n}px`,de.style.overflowY="auto"}async function _(e,t={}){const n=new Headers(t.headers||{});Q&&n.set("Authorization",`Bearer ${Q}`);const a=await fetch(e,{...t,headers:n});if(a.status===401){const r=await E(a.clone()),i=String(r&&r.detail||"").trim().toLowerCase();(i==="token_expired"||i==="invalid_token"||i==="invalid_token_signature"||i==="missing_auth_token")&&Zr()}return a}function Zr(){Ta||(Ta=!0,ft(),ne&&(clearInterval(ne),ne=null),m=null,Pe(),ha(),Ga("","",""),ra(!1),window.location.href="/login")}function Ga(e,t,n){Q=e||"",v=t||"",Ba=n||"",Q?(localStorage.setItem("auth_token",Q),localStorage.setItem("auth_role",v),localStorage.setItem("auth_email",Ba)):(localStorage.removeItem("auth_token"),localStorage.removeItem("auth_role"),localStorage.removeItem("auth_email")),Wn()}function Wn(){if(Cr){const r=String(v||"").split("_").filter(Boolean).map(i=>i.charAt(0).toUpperCase()+i.slice(1)).join(" ");Cr.textContent=Q?`${Ba||"User"} (${r||"User"})`:"Not logged in"}Nn&&(Nn.style.display=Q?"none":""),Rn&&(Rn.style.display=Q?"":"none");const e=V==="all"||V==="agent",t=V==="all"||V==="credit_evaluator";Er&&(Er.style.display=e&&v==="agent"?"":"none"),Lr&&(Lr.style.display=t&&v==="credit_evaluator"?"":"none"),ra(v==="credit_evaluator"&&V==="credit_evaluator"&&!!m||v==="credit_evaluator"&&V==="all"&&!!m)}function Pe(){xn&&(clearInterval(xn),xn=null)}function qa(){$a="",Cn=0,Ma="",zn=Date.now(),Dn="queued",On=!1}function Jr(e){const t=String(e&&e.status?e.status:"").toLowerCase(),n=String(e&&e.parse_mode?e.parse_mode:"").toLowerCase();if(t!=="processing"||n!=="text")return qa(),!1;const a=[t,String(e.step||""),String(e.progress??""),String(e.page||"")].join("|");return a===$a?Cn+=1:($a=a,Cn=0),Cn>=25}function Dr(){if(On)return;const e=String(Dn||"").toLowerCase();e!=="processing"&&e!=="queued"||zn&&(Date.now()-zn<45e3||(On=!0,k(100,"Processing appears stalled","failed",null,vt,{status:"failed",message:"processing_stale_timeout"}),O(),Pe()))}function Rt(){const e=Number(ze&&ze.total_pages?ze.total_pages:j.length),t=Number(ze&&ze.parsed_pages?ze.parsed_pages:0);return e>0&&t>=e}function st(e){In&&In.classList.toggle("is-locked",e),wr&&(wr.style.display=e?"":"none"),Ln&&(Ln.disabled=!!e),Bn&&(Bn.disabled=!!e),je&&(je.disabled=!e)}function ft(){Gt&&(clearTimeout(Gt),Gt=null)}function Qr(){v==="credit_evaluator"&&m&&me&&(ft(),Gt=setTimeout(async()=>{Gt=null,!(!ge||!me)&&await cn({silent:!0})},zi))}function oe(){v==="credit_evaluator"&&m&&(ge=!0,Lt+=1,dt(),Qr())}function dt(){if(!It)return;const e=me||P(),t=j.find(o=>String(o.page_key||"")===String(e||"")),n=String(t&&t.review_status||We||"").toLowerCase(),r=(n==="saved"||n==="reviewed")&&!ge,i=r?"Saved":"Not saved";It.classList.toggle("is-saved",r),It.classList.toggle("is-unsaved",!r),It.setAttribute("title",i),It.setAttribute("aria-label",i)}function Xa(e){return G(Number(e),0,1)}function ae(e){const t=[...e].map(Xa).sort((a,r)=>a-r),n=[];return t.forEach(a=>{(!n.length||Math.abs(a-n[n.length-1])>Un)&&n.push(a)}),n}function M(e,t=!1){if(!e)return{vertical:[],horizontal:[]};const n=String(e);return!qt[n]&&t&&(qt[n]={vertical:[],horizontal:[]}),qt[n]||{vertical:[],horizontal:[]}}function Kt(){return Di.map(e=>({...e}))}function Gn(e){const t=Kt(),n=new Map(t.map(s=>[s.key,s])),a=[],r=new Set;(Array.isArray(e)?e:[]).forEach(s=>{const c=String(s&&s.key?s.key:"").trim();if(!n.has(c)||r.has(c))return;r.add(c);const l=n.get(c),d=Number(s&&s.width);a.push({key:c,label:l.label,width:Number.isFinite(d)?d:l.width})}),t.forEach(s=>{r.has(s.key)||a.push({...s})});const i=a.map(s=>({...s,width:Math.max(De,Number(s.width||0))})),o=i.reduce((s,c)=>s+c.width,0)||1;return i.map(s=>({...s,width:s.width/o}))}function Ya(e){const t=[];let n=0;for(let a=0;a<e.length-1;a+=1)n+=Number(e[a].width||0),t.push(n);return ae(t)}function Be(e,t=!1){if(!e)return Kt();const n=String(e);!ot[n]&&t&&(ot[n]=Gn(Kt()));const a=ot[n]||Kt();return Gn(a)}function kt(e,t){if(!e)return;const n=String(e);ot[n]=Gn(t)}function ei(e){if(!e)return{column_layout:[],horizontal:[]};const t=Gn(Be(e,!0)),n=M(e,!0);return{column_layout:t.map(a=>({key:a.key,width:Number(Number(a.width||0).toFixed(6))})),horizontal:oa(n.horizontal||[]).map(a=>Number(a.toFixed(6)))}}function Gi(e,t){if(!e||!t||typeof t!="object")return;const n=M(e,!0),a=Array.isArray(t.column_layout)?t.column_layout.map(i=>({key:i&&i.key?String(i.key):"",width:Number(i&&i.width)})):[];a.length?(kt(e,a),n.vertical=Ya(Be(e,!0))):Va(e);const r=Array.isArray(t.horizontal);n.horizontal=oa(r?t.horizontal:[]),r&&ia(e)}function Ka(e){if(!e)return;const t=M(e,!1),n=ae(t&&t.vertical||[]),a=Be(e,!0);if(n.length!==a.length-1)return;const r=[0,...n,1],i=a.map((o,s)=>({...o,width:Math.max(De,r[s+1]-r[s])}));kt(e,i)}function qn(e,t={}){if(!e)return!1;const n={recordHistory:!1,invalidate:!0,redraw:!0,...t},a=M(e,!0),r=Z(a),i=Be(e,!0),o={vertical:Ya(i),horizontal:(a.horizontal||[]).slice()};return Bt(r,o)?(n.redraw&&R(),!1):(n.recordHistory&&ln(e,r),la(e,o),n.invalidate&&qe(e),_e(),N(),n.redraw&&R(),!0)}function Va(e){if(D()||!e)return;const t=String(e);if(!ot[t]){kt(t,Kt()),qn(t,{recordHistory:!1,invalidate:!1,redraw:!1});return}qn(t,{recordHistory:!1,invalidate:!1,redraw:!1})}function qi(e){return Be(e,!0).map(n=>n.key)}function un(){if(!S)return;if(D()){S.innerHTML="",S.classList.add("is-hidden"),Xn();return}const e=P();if(!e){S.innerHTML="",S.classList.add("is-hidden"),Xn();return}const t=Be(e,!0);H&&!t.some(i=>i.key===H)&&(H=""),S.classList.remove("is-hidden"),S.classList.toggle("is-resizing",!!Y),S.innerHTML="";const n=document.createElement("div");n.className="preview-columns-track";const a=[0];let r=0;if(t.forEach((i,o)=>{r+=Number(i.width||0),a.push(o===t.length-1?1:r)}),a.length!==t.length+1){a.length=0,a.push(0);for(let i=0;i<t.length;i+=1)a.push((i+1)/t.length)}t.forEach((i,o)=>{const s=G(a[o],0,1),c=G(a[o+1],0,1),l=Math.max(0,c-s),d=document.createElement("div");d.className="preview-col-item",d.draggable=!0,d.dataset.colKey=i.key,d.style.left=`${(s*100).toFixed(6)}%`,d.style.width=`${(l*100).toFixed(6)}%`,A.sourceKey&&A.sourceKey===i.key&&d.classList.add("is-drag-source"),A.targetKey&&A.targetKey===i.key&&d.classList.add("is-drop-target"),H&&H===i.key&&d.classList.add("is-selected");const u=document.createElement("span");if(u.className="preview-col-label",u.textContent=i.label,d.appendChild(u),o<t.length-1){const f=document.createElement("button");f.type="button",f.className="preview-col-resizer",f.dataset.resizeIndex=String(o),f.setAttribute("aria-label",`Resize ${i.label} column`),f.title=`Resize ${i.label}`,d.appendChild(f)}n.appendChild(d)});for(let i=1;i<a.length-1;i+=1){const o=document.createElement("span");o.className="preview-col-divider",o.style.left=`${(G(a[i],0,1)*100).toFixed(6)}%`,n.appendChild(o)}S.appendChild(n),Yi()}function Je(){if(!S)return;S.querySelectorAll(".preview-col-item").forEach(t=>{const n=String(t.dataset&&t.dataset.colKey?t.dataset.colKey:"");t.classList.toggle("is-drag-source",!!(A.sourceKey&&A.sourceKey===n)),t.classList.toggle("is-drop-target",!!(A.targetKey&&A.targetKey===n)),t.classList.toggle("is-selected",!!(H&&H===n))})}function Xn(){if(!S)return;S.style.paddingLeft="",S.style.paddingRight="";const e=S.querySelector(".preview-columns-track");e&&(e.style.left="0px",e.style.width="100%")}function ti(e,t){if(!S||!x)return;S.style.paddingLeft="",S.style.paddingRight="";const n=S.querySelector(".preview-columns-track");if(!n)return;const a=S.getBoundingClientRect(),r=x.getBoundingClientRect();if(!a.width||!r.width||!Number.isFinite(t)||t<=0){Xn();return}const i=window.getComputedStyle(S),o=Number.parseFloat(i.borderLeftWidth||"0")||0;Number.parseFloat(i.borderRightWidth||"0");const l=r.left-a.left+(Number.isFinite(e)?e:0)-o;n.style.left=`${l.toFixed(3)}px`,n.style.width=`${Number(t).toFixed(3)}px`}function Xi(){if(!S)return 0;const e=S.querySelector(".preview-columns-track");if(e){const t=e.getBoundingClientRect();if(t.width)return Math.max(1,t.width)}return Math.max(1,S.clientWidth||1)}function Yi(){if(!S||!x||!p||!p.naturalWidth){Xn();return}const e=x.getBoundingClientRect(),t=hn(p),n=t.left-e.left,a=Math.max(1,Math.round(t.width*W)),r=n+t.width/2+ve,i=Math.round(r-a/2);ti(i,a)}function ia(e){e&&(ea[String(e)]=!0)}function oa(e){const t=ae((e||[]).map(Xa)).filter(i=>i>et&&i<1-et),n=[];if(t.forEach(i=>{(!n.length||i-n[n.length-1]>=et)&&n.push(i)}),n.length<=ba)return n;const a=[],r=n.length/ba;for(let i=0;i<ba;i+=1)a.push(n[Math.floor(i*r)]);return ae(a)}function Ki(e){const n=(Array.isArray(se[e])?se[e]:[]).map(r=>({y1:G(Number(r&&r.y1),0,1),y2:G(Number(r&&r.y2),0,1)})).filter(r=>Number.isFinite(r.y1)&&Number.isFinite(r.y2)&&r.y2>r.y1).sort((r,i)=>(r.y1+r.y2)/2-(i.y1+i.y2)/2);if(n.length<2)return[];const a=[];for(let r=0;r<n.length-1;r+=1){const i=n[r],o=n[r+1],s=(i.y1+i.y2)/2,c=(o.y1+o.y2)/2,l=o.y1>i.y2?(i.y2+o.y1)/2:(s+c)/2;Number.isFinite(l)&&a.push(l)}return oa(a)}function ni(e,t={}){if(D()||!e)return!1;const n=String(e);if(ea[n])return!1;const a=M(n,!0);if((a.horizontal||[]).length)return!1;const r=Ki(n);if(!r.length)return!1;a.horizontal=r.slice();const i={redraw:!1,invalidate:!1,...t};return i.invalidate&&qe(n),_e(),N(),i.redraw&&R(),!0}function sa(){if(!z)return;if(D()){z.innerHTML="",z.classList.add("is-hidden");return}const e=P();if(!e){z.innerHTML="",z.classList.add("is-hidden");return}z.classList.remove("is-hidden"),z.classList.toggle("is-resizing",!!te);const t=M(e,!0),n=oa(t.horizontal||[]);Bt({vertical:[],horizontal:t.horizontal||[]},{vertical:[],horizontal:n})||(t.horizontal=n.slice()),z.innerHTML="",n.forEach((a,r)=>{const i=document.createElement("button");i.type="button",i.className="preview-row-handle",i.dataset.rowIndex=String(r),i.style.top=`${(a*100).toFixed(3)}%`,i.title=`Move row guide ${r+1}`,i.setAttribute("aria-label",`Move row guide ${r+1}`),z.appendChild(i)})}function Or(e,t,n){const a=Be(e,!0),r=a.findIndex(c=>c.key===t),i=a.findIndex(c=>c.key===n);if(r<0||i<0||r===i)return!1;const o=a.slice(),[s]=o.splice(r,1);return o.splice(i,0,s),kt(e,o),qn(e,{recordHistory:!1,invalidate:!0,redraw:!0}),un(),oe(),!0}function Vi(e,t,n,a={}){const r={redraw:!0,invalidate:!1,...a},i=Be(e,!0);if(t<0||t>=i.length-1)return!1;const o=i[t],s=i[t+1];if(!o||!s)return!1;const c=o.width+s.width;let l=o.width+n,d=s.width-n;if(l<De&&(l=De,d=c-l),d<De&&(d=De,l=c-d),l<De||d<De)return!1;const u=i.map(f=>({...f}));return u[t].width=l,u[t+1].width=d,kt(e,u),qn(e,{recordHistory:!1,invalidate:r.invalidate,redraw:r.redraw}),un(),!0}function Z(e){return{vertical:ae(e&&e.vertical||[]),horizontal:ae(e&&e.horizontal||[])}}function Bt(e,t){const n=e&&e.vertical||[],a=t&&t.vertical||[],r=e&&e.horizontal||[],i=t&&t.horizontal||[];if(n.length!==a.length||r.length!==i.length)return!1;for(let o=0;o<n.length;o+=1)if(Math.abs(n[o]-a[o])>Un)return!1;for(let o=0;o<r.length;o+=1)if(Math.abs(r[o]-i[o])>Un)return!1;return!0}function fn(e,t=!1){if(!e)return null;const n=String(e);return!Xt[n]&&t&&(Xt[n]={undo:[],redo:[]}),Xt[n]||null}function ln(e,t){const n=fn(e,!0);n.undo.push(Z(t)),n.undo.length>ja&&n.undo.shift(),n.redo=[]}function la(e,t){const n=M(e,!0),a=Z(t);n.vertical=a.vertical,n.horizontal=a.horizontal}function qe(e){delete ta[e],ca()}function Zi(e){const t=fn(e,!1);return!!(t&&t.undo.length)}function Ji(e){const t=fn(e,!1);return!!(t&&t.redo.length)}function ai(e){if(D())return[];Va(e);const t=M(e,!1),n=ae([0,...t.vertical||[],1]),a=ae([0,...t.horizontal||[],1]),r=[];for(let i=0;i<a.length-1;i+=1)for(let o=0;o<n.length-1;o+=1)r.push({x1:n[o],y1:a[i],x2:n[o+1],y2:a[i+1]});return r}function _e(){if(!vn)return;const e=P();if(!e){vn.textContent="";return}const t=M(e,!1),n=(t.vertical||[]).length+(t.horizontal||[]).length;if(!n){vn.textContent="No guides";return}const a=ai(e);vn.textContent=`${n} line${n===1?"":"s"} • ${a.length} section${a.length===1?"":"s"}`}function Yn(e){Yt=!!e,nt&&(nt.disabled=Yt||!h.length||!b,nt.textContent=Yt?"OCR...":"OCR")}function Ur(e){dn=!!e,N()}function jr(e){const t=String(e||"").toLowerCase();return{deskew:"Deskew",contrast:"Contrast",binarize:"Binarize",denoise:"Denoise",sharpen:"Sharpen",remove_lines:"Remove lines",reset:"Reset cleanup"}[t]||t}async function Qi(e){if(!e||!b||!h.length||dn)return;const t=P();if(t)try{Ur(!0);const n=await _(`/jobs/${b}/pages/${t}/image-tool`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({tool:e})}),a=await E(n);if(!n.ok)throw new Error(a&&a.detail||`Failed to apply ${jr(e)}`);await tr(t),U()}catch(n){alert(n.message||`Failed to apply ${jr(e)}`)}finally{Ur(!1)}}function eo(e){ne&&(clearInterval(ne),ne=null),Oe=10,Ge();const t=`Running section OCR (${e} section${e===1?"":"s"})`;k(Oe,t,"section_ocr","tesseract","ocr"),ne=setInterval(()=>{const n=Oe<60?4:2;Oe=Math.min(92,Oe+n),k(Oe,t,"section_ocr","tesseract","ocr")},700)}function Hr(e,t=0,n=""){if(ne&&(clearInterval(ne),ne=null),e)k(100,`Section OCR completed (${t} section${t===1?"":"s"})`,"section_ocr","tesseract","ocr");else{const a=n||"Section OCR failed";k(Math.max(0,Oe),a,"failed","tesseract","ocr")}O()}function ca(e){ya&&(ya.innerHTML="",ya.classList.add("is-hidden"))}function ye(e){return String(e||"").replace(/\s+/g," ").trim()}function ri(e){const t=ye(e).toLowerCase();return t?/\b(book\s+date|value\s+date|posting\s+date|date)\b/.test(t)?"date":/\b(description|particulars?|details?|transaction)\b/.test(t)?"description":/\b(debit|withdraw(al)?|debits|dr)\b/.test(t)?"debit":/\b(credit|deposit|credits|cr)\b/.test(t)?"credit":/\b(balance|ending\s+balance|closing\s+balance|end\s+balance)\b/.test(t)?"balance":"":""}function to(e,t){return t>=5?["date","description","debit","credit","balance"][e]||"description":t===4?["date","description","debit","balance"][e]||"description":t===3?["date","description","balance"][e]||"description":t===2&&["date","description"][e]||"description"}function no(e){const t=[];return[...e].sort((r,i)=>{const o=Number(r.y1||0),s=Number(i.y1||0);return Math.abs(o-s)>1e-4?o-s:Number(r.x1||0)-Number(i.x1||0)}).forEach(r=>{const i=Number(r.y1||0),o=Number(r.y2||0);let s=t.find(c=>Math.abs(c.y1-i)<=.01&&Math.abs(c.y2-o)<=.01);s?(s.y1=Math.min(s.y1,i),s.y2=Math.max(s.y2,o)):(s={y1:i,y2:o,cells:[]},t.push(s)),s.cells.push(r)}),t.forEach(r=>{r.cells.sort((i,o)=>Number(i.x1||0)-Number(o.x1||0))}),t.sort((r,i)=>r.y1-i.y1),t}function ao(e){let t=-1,n=0;return e.forEach((a,r)=>{const i=new Set;if(a.cells.forEach(s=>{const c=ri(s.text);c&&i.add(c)}),i.size<2)return;let o=i.size;i.has("date")&&(o+=1),i.has("balance")&&(o+=1),o>n&&(n=o,t=r)}),t}function ro(e){const t=["date","description","debit","credit","balance"];return e.cells.map((a,r)=>ri(a.text)||t[r]||"description")}function wa(e){const t=ye(e);if(!t)return"";const n=Xe(t);return Number.isFinite(n)?String(n):""}function io(e){const t=ye(`${e.date} ${e.description} ${e.debit} ${e.credit} ${e.balance}`).toLowerCase();let n=0;return/\bdate\b/.test(t)&&(n+=1),/\bdescription|particulars?|details?\b/.test(t)&&(n+=1),/\bdebit|credit|balance\b/.test(t)&&(n+=1),n>=2}function oo(e,t){const n=Array.isArray(t&&t.sections)?t.sections:[];if(!n.length)return{rows:[],bounds:[]};const a=n.map(f=>({x1:Number(f.x1||0),y1:Number(f.y1||0),x2:Number(f.x2||0),y2:Number(f.y2||0),text:ye(f.text)})),r=no(a);if(!r.length)return{rows:[],bounds:[]};const i=qi(e),o=i&&i.length?-1:ao(r),s=i&&i.length?i:o>=0?ro(r[o]):null,c=o>=0?r.slice(o+1):r,l=[],d=[];let u=1;return c.forEach(f=>{const w=f.cells||[];if(!w.length)return;const g={row_id:String(u).padStart(3,"0"),page:e,date:"",description:"",debit:"",credit:"",balance:""};if(w.forEach((pe,$t)=>{const X=ye(pe.text);if(!X)return;const Mt=s&&s[$t]||to($t,w.length);if(Mt==="description"){g.description=g.description?`${g.description} ${X}`:X;return}if(Mt==="date"){g.date||(g.date=X);return}if(Mt==="debit"){g.debit||(g.debit=wa(X)||X);return}if(Mt==="credit"){g.credit||(g.credit=wa(X)||X);return}if(Mt==="balance"){g.balance||(g.balance=wa(X)||X);return}g.description=g.description?`${g.description} ${X}`:X}),g.description=ye(g.description),!!!(ye(g.date)||ye(g.description)||ye(g.debit)||ye(g.credit)||ye(g.balance))||io(g))return;const T=Math.max(0,Math.min(1,Math.min(...w.map(pe=>Number(pe.x1||0))))),gt=Math.max(0,Math.min(1,Math.min(...w.map(pe=>Number(pe.y1||0))))),mt=Math.max(0,Math.min(1,Math.max(...w.map(pe=>Number(pe.x2||0))))),wn=Math.max(0,Math.min(1,Math.max(...w.map(pe=>Number(pe.y2||0)))));g.x1=T,g.y1=gt,g.x2=mt,g.y2=wn,l.push(g),d.push({row_id:g.row_id,x1:T,y1:gt,x2:mt,y2:wn}),u+=1}),{rows:l,bounds:d}}async function so(){if(!b||!h.length)return;const e=P();if(!e)return;const t=ai(e);if(!t.length){alert("No sections available for OCR.");return}try{Yn(!0),eo(t.length);const n=await _(`/jobs/${b}/pages/${e}/ocr-sections`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sections:t,guide_state:ei(e)})}),a=await E(n);if(!n.ok)throw new Error(a&&a.detail||"Section OCR failed");const r=a&&a.profile_analyzer?a.profile_analyzer:null;ta[e]=a||{sections:[]},ca(e);const i=Array.isArray(a&&a.parsed_rows)?a.parsed_rows:[],o=Array.isArray(a&&a.parsed_bounds)?a.parsed_bounds:[],s=oo(e,a||{}),c=i.length?i:s.rows,l=i.length?o:s.bounds;c.length?(wt[e]=c,se[e]=l,di(c,e),re=y.length?y[0].row_key:null,oe(),U()):alert("Section OCR completed, but no table rows were detected from the selected sections."),Hr(!0,Array.isArray(a&&a.sections)?a.sections.length:t.length),r&&Xo(r,"tesseract","ocr")}catch(n){Hr(!1,0,n.message||"Section OCR failed"),alert(n.message||"Section OCR failed")}finally{Yn(!1),N()}}function N(){const e=P(),t=D();if(Ha(),Ot&&(Ot.classList.toggle("is-active",K==="horizontal"),Ot.disabled=!e||t),Tn&&(Tn.disabled=!e||!Zi(e)||t),$n&&($n.disabled=!e||!Ji(e)||t),x&&x.classList.toggle("guide-selecting",K!=="none"),nt&&(nt.disabled=Yt||!h.length||!b||t),Mn.length){const n=dn||Yt||!h.length||!b||t;Mn.forEach(a=>{a.disabled=n})}_e(),un(),sa()}function lo(e){K=K===e?"none":e,K!=="none"&&$&&($=!1,J=[],q()),bn(),N(),gn()}function co(){const e=P();if(!e)return;const t=M(e,!0),n=Z(t),a=Ya(Be(e,!0)),r=n.horizontal.length>0,i=Bt({vertical:n.vertical,horizontal:[]},{vertical:a,horizontal:[]});if(!r&&i){N();return}ln(e,n),t.vertical=a,t.horizontal=[],ia(e),qe(e),Ka(e),_e(),N(),oe(),R()}function ii(e,t){const n=P();if(!n)return!1;const a=M(n,!0),r=Z(a),i=a.horizontal,o=Xa(t);if(i.some(c=>Math.abs(c-o)<=Un))return!1;i.push(o);const s=Z(a);return Bt(r,s)?!1:(la(n,s),ln(n,r),ia(n),qe(n),_e(),N(),oe(),!0)}function uo(){const e=P();if(!e)return!1;const t=fn(e,!1);if(!t||!t.undo.length)return N(),!1;const n=Z(M(e,!0)),a=t.undo.pop();return t.redo.push(n),t.redo.length>ja&&t.redo.shift(),la(e,a),Ka(e),qe(e),_e(),N(),oe(),R(),!0}function fo(){const e=P();if(!e)return!1;const t=fn(e,!1);if(!t||!t.redo.length)return N(),!1;const n=Z(M(e,!0)),a=t.redo.pop();return t.undo.push(n),t.undo.length>ja&&t.undo.shift(),la(e,a),Ka(e),qe(e),_e(),N(),oe(),R(),!0}function gn(){if(!I)return;const e=K!=="none"&&h.length&&p.naturalWidth,t=$&&!ie;I.style.pointerEvents=e||t?"auto":"none"}function go(e){if(!p.naturalWidth||!x)return null;const t=x.getBoundingClientRect(),n=hn(p),a=n.left-t.left,r=n.top-t.top,i=n.width,o=n.height;if(i<=0||o<=0)return null;const s=e.clientX-t.left,c=e.clientY-t.top,l=a+i/2+ve,d=r+o/2+Ee,u=(s-l)/W+i/2,f=(c-d)/W+o/2,w=u/i,g=f/o;return w<0||w>1||g<0||g>1?null:{x:w,y:g}}function mo(e,t,n,a){if(D())return;const r=M(t,!1),i=ae(r.vertical||[]),o=ae(r.horizontal||[]);if(!i.length&&!o.length)return;const s=ae([0,...i,1]),c=ae([0,...o,1]);e.save();for(let l=0;l<c.length-1;l+=1)for(let d=0;d<s.length-1;d+=1){if((d+l)%2!==0)continue;const u=s[d]*n,f=c[l]*a,w=s[d+1]*n,g=c[l+1]*a;e.fillStyle="rgba(20, 184, 166, 0.04)",e.fillRect(u,f,Math.max(1,w-u),Math.max(1,g-f))}e.strokeStyle="rgba(13, 148, 136, 0.95)",e.lineWidth=1,i.forEach(l=>{const d=l*n;e.beginPath(),e.moveTo(d,0),e.lineTo(d,a),e.stroke()}),o.forEach(l=>{const d=l*a;e.beginPath(),e.moveTo(0,d),e.lineTo(n,d),e.stroke()}),e.restore()}async function po(){const e=(Sr&&Sr.value||"").trim(),t=(xr&&xr.value||"").trim();if(!e||!t){alert("Enter email and password.");return}const n=await fetch("/auth/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,password:t})}),a=await E(n);if(!n.ok){alert(a&&a.detail||"Login failed");return}const r=a.role||"";if(r==="agent"&&V==="credit_evaluator"){window.location.href="/agent";return}if(r==="credit_evaluator"&&V==="agent"){window.location.href="/evaluator";return}if(r==="admin"){window.location.href="/admin";return}Ga(a.access_token||"",a.role||"",e),v==="agent"?await da():v==="credit_evaluator"&&await Ke()}function ho(){Ta=!1,ft(),m=null,Pe(),ha(),Ga("","",""),ra(!1),window.location.href="/login"}function oi(e){if(!e)return"-";const t=new Date(e);if(Number.isNaN(t.getTime()))return"-";const n=String(t.getMonth()+1).padStart(2,"0"),a=String(t.getDate()).padStart(2,"0"),r=t.getFullYear();return`${n}/${a}/${r}`}function si(e){const t=String(e&&e.original_filename||"").trim();if(t)return t;const n=String(e&&e.input_pdf_key||"").trim();if(!n)return"-";const a=n.split("/").filter(Boolean);return a.length?a[a.length-1]:n}function yo(e){return String(e||"").trim().replace(/\s+/g," ").toLowerCase()}function li(e){return String(e&&e.saved_at||"").trim()||null}function bo(){const e=new Set((sn||[]).map(t=>String(t.id||"")));Re.forEach(t=>{e.has(t)||Re.delete(t)})}function lt(){if(!jt)return;const e=Re.size;jt.disabled=Pa||e<2,jt.textContent=e>0?`Combine Selected (${e})`:"Combine Selected"}function wo(){if(!Re.size)return[];const e=new Map((sn||[]).map(t=>[String(t.id||""),t]));return Array.from(Re).map(t=>e.get(String(t))).filter(Boolean)}async function vo(){const e=wo();if(e.length<2){alert("Select at least two submissions to combine.");return}const t=e.map(n=>yo(n.borrower_name));if(t.some(n=>!n)||t.some(n=>n!==t[0])){alert("Combine only supports submissions with the same borrower name.");return}Pa=!0,lt();try{const n=e.map(i=>String(i.id)),a=await _("/evaluator/submissions/combine",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({submission_ids:n})}),r=await E(a);if(!a.ok){alert(r&&r.detail||"Failed to combine submissions");return}Re=new Set,lt(),await Ke(),r&&r.submission_id?alert(`Combined successfully. New submission: ${r.submission_id}`):alert("Combined successfully.")}finally{Pa=!1,lt()}}function Wr(e){if(!e.length)return'<div class="table-empty">No submissions yet</div>';const t=Math.max(1,Math.ceil(e.length/_n));le>t&&(le=t),le<1&&(le=1);const n=(le-1)*_n,a=e.slice(n,n+_n),r=a.map(l=>`<tr>
      <td>${C(oi(l.created_at))}</td>
      <td>${C(si(l))}</td>
      <td>${C(l.borrower_name||"-")}</td>
      <td>${C(l.lead_reference||"-")}</td>
      <td class="agent-submission-id" title="${C(l.id||"-")}">${C(l.id||"-")}</td>
    </tr>`),i=Math.max(0,_n-a.length);for(let l=0;l<i;l+=1)r.push('<tr class="agent-row-filler"><td colspan="5"></td></tr>');const o=r.join(""),c=Array.from({length:t},(l,d)=>d+1).map(l=>`<button class="agent-page-btn${l===le?" is-active":""}" data-page="${l}">${l}</button>`).join("");return`<div class="agent-submissions-table-inner">
    <table class="agent-submissions-grid agent-submissions-grid-agent">
      <thead>
        <tr>
          <th>Date</th>
          <th>Filename</th>
          <th>Borrower Name</th>
          <th>Lead Reference</th>
          <th>Submission ID</th>
        </tr>
      </thead>
      <tbody>${o}</tbody>
    </table>
    <div class="agent-pagination">
      <button class="agent-page-btn" data-page-nav="prev" ${le<=1?"disabled":""}>Prev</button>
      <div class="agent-page-list">${c}</div>
      <button class="agent-page-btn" data-page-nav="next" ${le>=t?"disabled":""}>Next</button>
    </div>
  </div>`}function Kn(){const e=(An&&An.value||"").trim().toLowerCase();if(!e){Ct.innerHTML=Wr(ka);return}const t=ka.filter(n=>String(n.borrower_name||"").toLowerCase().includes(e));Ct.innerHTML=Wr(t)}function Gr(e){if(!e.length)return'<div class="table-empty">No submissions in queue</div>';const t=Math.max(1,Math.ceil(e.length/Sn));ce>t&&(ce=t),ce<1&&(ce=1);const n=(ce-1)*Sn,a=e.slice(n,n+Sn),r=a.map(l=>{const d=String(l.status||"-"),u=Vo(d),f=`workflow-status workflow-status-${d.toLowerCase().replace(/[^a-z0-9]+/g,"-")}`,w=l.assigned_evaluator_id?"":`<button class="preview-nav workflow-mini-btn" data-action="assign" data-id="${l.id}">Assign</button>`,g=l.assigned_evaluator_id?`<button class="preview-nav workflow-mini-btn" data-action="open" data-id="${l.id}">Open</button>`:"",B=si(l),T=Re.has(String(l.id||""))?" checked":"";return`<tr>
      <td><input type="checkbox" class="evaluator-select-checkbox" data-submission-id="${C(String(l.id||""))}"${T}></td>
      <td>${C(oi(l.created_at))}</td>
      <td class="submission-filename-cell" title="${C(B)}">${C(B)}</td>
      <td title="${C(l.borrower_name||"-")}">${C(l.borrower_name||"-")}</td>
      <td class="agent-submission-id" title="${C(l.id||"-")}">${C(l.id||"-")}</td>
      <td><span class="${f}">${C(u)}</span></td>
      <td class="workflow-item-actions">${w}${g}</td>
    </tr>`}),i=Math.max(0,Sn-a.length);for(let l=0;l<i;l+=1)r.push('<tr class="agent-row-filler"><td colspan="7"></td></tr>');const o=r.join(""),c=Array.from({length:t},(l,d)=>d+1).map(l=>`<button class="agent-page-btn${l===ce?" is-active":""}" data-evaluator-page="${l}">${l}</button>`).join("");return`<div class="agent-submissions-table-inner">
    <table class="agent-submissions-grid agent-submissions-grid-evaluator">
      <thead>
        <tr>
          <th>Select</th>
          <th>Date</th>
          <th>Filename</th>
          <th>Borrower Name</th>
          <th>Submission ID</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>${o}</tbody>
    </table>
    <div class="agent-pagination">
      <button class="agent-page-btn" data-evaluator-page-nav="prev" ${ce<=1?"disabled":""}>Prev</button>
      <div class="agent-page-list">${c}</div>
      <button class="agent-page-btn" data-evaluator-page-nav="next" ${ce>=t?"disabled":""}>Next</button>
    </div>
  </div>`}function Vn(){const e=(Fn&&Fn.value||"").trim().toLowerCase();if(!e){at.innerHTML=Gr(sn),lt();return}const t=sn.filter(n=>String(n.borrower_name||"").toLowerCase().includes(e));at.innerHTML=Gr(t),lt()}async function da(){if(!Ct||!Q)return;const e=await _("/agent/submissions"),t=await E(e);if(!e.ok){Ct.innerHTML=`<div class="table-empty">${C(t&&t.detail||"Failed to load submissions")}</div>`;return}ka=t&&t.items||[],Kn()}function Pt(){return we&&we.files?Array.from(we.files):[]}function _t(){if(!Me||Kr)return;const e=Pt().length,t=ee&&ee.value?ee.value.trim():"";Me.disabled=e===0||!t,Me.textContent=e>0?`Submit Files (${e})`:"Submit Files (0)"}function Na(e,t){const n=Math.max(0,Math.min(100,Math.round(e)));Pr&&(Pr.style.width=`${n}%`),$r&&($r.textContent=`${n}%`),Tr&&t&&(Tr.textContent=t)}function va(e){if(Kr=e,Me){const t=ee&&ee.value?ee.value.trim():"";Me.disabled=e||Pt().length===0||!t,Me.classList.toggle("is-loading",e),e?Me.textContent="Submitting":_t()}kr&&kr.classList.toggle("is-hidden",!e),e||Na(0,"Uploading...")}function _o(e,t,n,a,r){return new Promise((i,o)=>{const s=new FormData;s.append("file",e),s.append("mode",t),n&&s.append("borrower_name",n),a&&s.append("lead_reference",a);const c=new XMLHttpRequest;c.open("POST","/agent/submissions"),Q&&c.setRequestHeader("Authorization",`Bearer ${Q}`),c.upload.onprogress=l=>{if(!l.lengthComputable)return;const d=l.total>0?l.loaded/l.total:0;r&&r(Math.max(0,Math.min(1,d)))},c.onerror=()=>o(new Error("Network error during upload")),c.onload=()=>{let l=null;try{l=c.responseText?JSON.parse(c.responseText):null}catch{l=null}if(c.status>=200&&c.status<300)i(l||{});else{if(c.status===401){const d=String(l&&l.detail||"").trim().toLowerCase();(d==="token_expired"||d==="invalid_token"||d==="invalid_token_signature"||d==="missing_auth_token")&&Zr()}o(new Error(l&&l.detail||`Upload failed for ${e.name}`))}},c.send(s)})}function ci(e){if(!we)return;const t=new DataTransfer;e.forEach(n=>t.items.add(n)),we.files=t.files}function mn(){if(!Ut){_t();return}const e=Pt();if(!e.length){Ut.innerHTML='<div class="agent-files-empty">No file selected</div>',_t();return}Ut.innerHTML=e.map((t,n)=>`
    <div class="agent-file-item">
      <i class="far fa-file-pdf"></i>
      <div class="agent-file-meta">
        <div class="agent-file-name">${C(t.name)}</div>
        <div class="agent-file-size">${Li(t.size)}</div>
      </div>
      <button class="agent-file-remove" data-index="${n}" aria-label="Remove file">×</button>
    </div>
  `).join(""),_t()}async function So(){const e=Pt();if(!e.length){alert("Select at least one PDF first.");return}const t=ee&&ee.value.trim()?ee.value.trim():"";if(!t){alert("Borrower name is required.");return}const n=Nt&&Nt.value.trim()?Nt.value.trim():"",a=aa();va(!0);let r=0;try{const i=e.length;for(let o=0;o<i;o+=1){const s=e[o];await _o(s,a,t,n,c=>{const l=(o+c)/i*100;Na(l,`Uploading ${o+1}/${i}`)}),r+=1,Na((o+1)/i*100,`Uploading ${o+1}/${i}`)}}catch(i){va(!1),alert(i.message||"Submission failed");return}we.value="",mn(),ee&&(ee.value=""),Nt&&(Nt.value=""),va(!1),await da(),alert(`Submitted ${r} file(s).`)}async function Ke(){if(!at||!Q)return;const e=await _("/evaluator/submissions?include_unassigned=true"),t=await E(e);if(!e.ok){at.innerHTML=`<div class="table-empty">${C(t&&t.detail||"Failed to load queue")}</div>`;return}sn=t&&t.items||[],bo(),Vn()}async function xo(e){const t=await _(`/evaluator/submissions/${e}/assign`,{method:"POST"}),n=await E(t);if(!t.ok){alert(n&&n.detail||"Assign failed");return}await Ke()}function Co(e,t,n){const a=String(e.row_id||e.row_index||n+1).padStart(3,"0"),r={row_key:Ve(),global_row_id:a,row_id:a,date:e.date||"",description:e.description||"",debit:e.debit!=null?String(e.debit):"",credit:e.credit!=null?String(e.credit):"",balance:e.balance!=null?String(e.balance):"",page:t,page_row_id:a,x1:e.x1,y1:e.y1,x2:e.x2,y2:e.y2};return rr(r),r}function Ae(e){const t=Number(e);return Number.isFinite(t)?t:null}function Ce(e,t=1){const n=String(e??t).trim();return n?/^\d+$/.test(n)?n.padStart(3,"0"):n:String(t).padStart(3,"0")}function Eo(e,t,n){const a=Array.isArray(se[e])?se[e]:[];if(a.length){const i=new Set;[t&&t.page_row_id,t&&t.row_id,t&&t.global_row_id].forEach(o=>{const s=Ce(o,n+1);s&&i.add(s)});for(let o=0;o<a.length;o+=1){const s=a[o],c=Ce(s&&s.row_id,o+1);if(i.has(c))return s;const l=Ce(Ne[`${e}|${c}`],o+1);if(i.has(l))return s}if(n>=0&&n<a.length)return a[n]}const r=Za(e,t,n);return r?{row_id:Ce(t&&(t.page_row_id||t.row_id||t.global_row_id),n+1),...r}:null}function Lo(e,t,n){if(!t||!Array.isArray(n)||!n.length)return null;const a=new Set;if([t.page_row_id,t.row_id,t.global_row_id].forEach(i=>{const o=Ce(i,1);o&&a.add(o)}),!a.size)return null;for(let i=0;i<n.length;i+=1){const o=n[i],s=Ce(o&&o.row_id,i+1);if(a.has(s))return o;const c=Ce(Ne[`${e}|${s}`],i+1);if(a.has(c))return o}const r=y.findIndex(i=>i&&i.row_key===t.row_key);return r>=0&&r<n.length?n[r]:null}function Vt(e,t,n){if(!e||typeof e!="object")return null;const a=Number(e.x1),r=Number(e.y1),i=Number(e.x2),o=Number(e.y2);if(![a,r,i,o].every(Number.isFinite))return null;let s=a,c=r,l=i,d=o;if(!(s>=-.01&&c>=-.01&&l<=1.01&&d<=1.01)){if(!Number.isFinite(t)||!Number.isFinite(n)||t<=0||n<=0)return null;s/=t,l/=t,c/=n,d/=n}const f=G(Math.min(s,l),0,1),w=G(Math.max(s,l),0,1),g=G(Math.min(c,d),0,1),B=G(Math.max(c,d),0,1);return w-f<5e-4||B-g<5e-4?null:{x1:f,y1:g,x2:w,y2:B}}function Bo(e,t=0){const n=Number.isInteger(t)?t:Number(t||0),a=[e&&e.page_row_id,e&&e.row_id,e&&e.global_row_id];for(let r=0;r<a.length;r+=1){const i=String(a[r]!=null?a[r]:"").trim();if(!/^\d+$/.test(i))continue;const o=Number(i)-1;if(Number.isInteger(o)&&o>=0)return o}return Number.isInteger(n)&&n>=0?n:0}function Za(e,t,n=0){if(!e)return null;const a=M(e,!1);if(!a||!Array.isArray(a.horizontal)||!a.horizontal.length)return null;const r=ae([0,...a.horizontal,1]);if(r.length<2)return null;const i=G(Bo(t,n),0,Math.max(0,r.length-2)),o=Number(r[i]),s=Number(r[i+1]);return!Number.isFinite(o)||!Number.isFinite(s)||s-o<5e-4?null:{x1:0,y1:o,x2:1,y2:s}}function ko(e,t){const n=[];return(Array.isArray(t)?t:[]).forEach((a,r)=>{const i=Za(e,a,r);if(!i)return;const o=Ce(a&&(a.page_row_id||a.row_id||a.global_row_id),r+1);n.push({row_id:o,...i})}),n}function Po(e,t){if(!t)return null;const n=Array.isArray(se[e])?se[e]:[],a=Lo(e,t,n),r=y.findIndex(c=>c&&c.row_key===t.row_key),i=Za(e,t,r>=0?r:0),o=p&&p.naturalWidth?p.naturalWidth:0,s=p&&p.naturalHeight?p.naturalHeight:0;return Vt(a,o,s)||Vt(t,o,s)||Vt(i,o,s)}function To(e,t){const n=[],a=new Set;return(Array.isArray(t)?t:[]).forEach((r,i)=>{const o=Ce(r&&r.row_id,i+1),s=Ae(r&&r.x1),c=Ae(r&&r.y1),l=Ae(r&&r.x2),d=Ae(r&&r.y2);s==null||c==null||l==null||d==null||(n.push({row_id:o,x1:s,y1:c,x2:l,y2:d}),a.add(o))}),(Array.isArray(e)?e:[]).forEach((r,i)=>{const o=Ce(r&&(r.row_id||r.page_row_id),i+1);if(a.has(o))return;const s=Ae(r&&r.x1),c=Ae(r&&r.y1),l=Ae(r&&r.x2),d=Ae(r&&r.y2);s==null||c==null||l==null||d==null||(n.push({row_id:o,x1:s,y1:c,x2:l,y2:d}),a.add(o))}),n}function di(e,t){y=(e||[]).map((n,a)=>Co(n,t,a)),nn=1,y.forEach(n=>{n.row_key=Ve()}),Ne={},y.forEach(n=>{Ne[`${t}|${n.page_row_id}`]=n.global_row_id}),ut(y),y.length?(re=y[0].row_key,pn()):re=null}function ua(e){if(!e||typeof e!="object"){Jt.textContent="0",Qt.textContent="0",en.textContent="0",tn.textContent="-",xi([]);return}Jt.textContent=String(e.total_transactions||0),Qt.textContent=String(e.debit_transactions||0),en.textContent=String(e.credit_transactions||0),tn.textContent=Number.isFinite(Number(e.adb))?F(Math.abs(Number(e.adb)),!0):"-";const t=document.getElementById("monthlySummaryBody"),n=document.querySelector(".monthly-summary-wrap"),a=Array.isArray(e.monthly)?e.monthly:[];if(t){if(!a.length){n&&n.classList.add("is-empty"),t.innerHTML='<tr><td class="monthly-empty" colspan="6">No monthly data</td></tr>';return}n&&n.classList.remove("is-empty"),t.innerHTML=a.map(r=>`<tr>
      <td>${C(String(r.month||r.monthLabel||"-"))}</td>
      <td>${C(F(Math.abs(Number(r.debit||0)),!0))}</td>
      <td>${C(F(Math.abs(Number(r.credit||0)),!0))}</td>
      <td>${C(F(Math.abs(Number(r.avg_debit||r.avgDebit||0)),!0))}</td>
      <td>${C(F(Math.abs(Number(r.avg_credit||r.avgCredit||0)),!0))}</td>
      <td>${C(F(Number(r.adb||0),!0))}</td>
    </tr>`).join("")}}async function ui(){if(!m||!m.id)return;const e=await _(`/evaluator/submissions/${m.id}`),t=await E(e);if(!e.ok)return;const n=t&&t.summary?t.summary:null;ua(n)}async function Ra(){if(!m||!m.id)return!1;const e=await _(`/evaluator/submissions/${m.id}/pages`),t=await E(e);if(!e.ok){const n=t&&t.detail?String(t.detail):`HTTP ${e.status}`;throw new Error(`Page manifest failed: ${n}`)}return j=Array.isArray(t.pages)?t.pages:[],ze=t.review_progress||{total_pages:j.length,parsed_pages:0,reviewed_pages:0,percent:0},Le=!!t.can_export,st(!Le),Le&&await ui(),h=j.map(n=>`${n.page_key}.png`),h.length?(L>=h.length&&(L=h.length-1),Aa(),!0):(We="pending",dt(),L=0,U(),!0)}async function $o(e){if(!e||!e.current_job_id)return;b=e.current_job_id;const t=await _(`/jobs/${b}`),n=await E(t);if(t.ok&&n&&n.status==="done"){k(100,"Results ready",n.step||"completed",n.ocr_backend,n.parse_mode,n),O(),await gi();return}if(t.ok&&n&&n.status==="failed"){const i=n.step||n.status||"failed",o=Number.isFinite(n.progress)?n.progress:Jn(n.status,i);k(o,n.message||"OCR job failed",i,n.ocr_backend,n.parse_mode,n),O(),alert("Job failed. Check diagnostics.");return}if(t.ok&&n&&n.status==="processing"){Ge();try{await Zn()}finally{O()}return}const a=await _(`/jobs/${b}/start`,{method:"POST"}),r=await E(a);if(!a.ok)throw new Error(r&&r.detail||"Failed to start processing");await Ke(),k(2,"Processing started","processing"),Ge();try{await Zn()}finally{O()}}async function En(e){if(!m||!m.id)return;ft();const t=e||P();if(!t)return;const n=await _(`/evaluator/submissions/${m.id}/pages/${t}`),a=await E(n);if(!n.ok){me=t,We="pending",ge=!1,Lt=0,dt();return}const r=Array.isArray(a.rows)?a.rows:[],i=Array.isArray(a.bounds)?a.bounds:[];wt[t]=r,Gi(t,a.guide_state||{});const o=To(r,i);se[t]=o.length?o:ko(t,r),he[t]=Array.isArray(a.identity_bounds)?a.identity_bounds:[],Wt=li(a.page_status),We=a.page_status&&a.page_status.review_status?String(a.page_status.review_status):"pending",me=t,ge=!1,Lt=0,dt(),di(r,t),U()}async function cn(e={}){const t={silent:!1,...e};if(!m||!m.id)return!0;const n=me||P();if(!n)return!0;const a=String(We||"").toLowerCase();if(!ge&&(a==="saved"||a==="reviewed"))return!0;if(pt)return pt;ft(),pt=(async()=>{const o=Lt,s=n,c=y.map((u,f)=>({...(function(){const g=Vt(u,1,1);if(g)return{x1:g.x1,y1:g.y1,x2:g.x2,y2:g.y2};const B=Eo(n,u,f),T=Vt(B,1,1);return T?{x1:T.x1,y1:T.y1,x2:T.x2,y2:T.y2}:{x1:u.x1,y1:u.y1,x2:u.x2,y2:u.y2}})(),row_id:u.page_row_id||u.row_id||String(f+1).padStart(3,"0"),page:n,date:u.date||"",description:u.description||"",debit:u.debit||"",credit:u.credit||"",balance:u.balance||""})),l=await _(`/evaluator/submissions/${m.id}/pages/${n}/transactions`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({rows:c,expected_updated_at:Wt,guide_state:ei(n)})}),d=await E(l);if(!l.ok){const u=d&&d.detail||"Failed to auto-save page";return t.silent?console.warn(u):alert(u),!1}if(Wt=li(d.page_status)||Wt,String(me||"")===String(s||"")&&Lt===o?ge=!1:ge=!0,We=d.page_status&&d.page_status.review_status?String(d.page_status.review_status):We,n&&d.page_status){const u=j.findIndex(f=>String(f.page_key||"")===String(n));u>=0&&(j[u]={...j[u],review_status:d.page_status.review_status||j[u].review_status,parse_status:d.page_status.parse_status||j[u].parse_status,saved_at:d.page_status.saved_at||j[u].saved_at,updated_at:d.page_status.updated_at||j[u].updated_at,rows_count:Number.isFinite(d.page_status.rows_count)?d.page_status.rows_count:j[u].rows_count,has_unsaved:!!d.page_status.has_unsaved})}return dt(),ge&&Qr(),Le=!!d.can_export,st(!Le),d.summary&&Le&&ua(d.summary),!0})();try{return await pt}finally{pt=null}}async function Ja(e){if(!h.length)return;const t=Math.max(0,Math.min(h.length-1,e));if(t===L&&me)return;ft();const n=me||P();if(!await cn()||String(me||P()||"")===String(n||"")&&ge&&(!await cn()||ge))return;L=t;const r=P();await En(r)}async function Mo(e){const t=await _(`/evaluator/submissions/${e}`),n=await E(t);if(!t.ok){alert(n&&n.detail||"Open failed");return}if(m=n.submission||null,!m)return;if(Wn(),yi(),Pe(),pa(),qa(),ir(),k(0,"For Review","for_review"),st(!0),b=m.current_job_id,!b){y=(n.transactions||[]).map((d,u)=>({row_key:Ve(),global_row_id:String(u+1).padStart(3,"0"),row_id:String(u+1).padStart(3,"0"),date:d.date||"",description:d.description||"",debit:d.debit!=null?String(d.debit):"",credit:d.credit!=null?String(d.credit):"",balance:d.balance!=null?String(d.balance):"",page:d.page||"",page_row_id:""})),ut(y);const l=!!(n.review_status&&n.review_status.can_export);st(!l),n.summary&&l&&ua(n.summary);return}if(String(m.status||"").toLowerCase()==="for_review"){let l=!0;const d=await _(`/jobs/${b}`),u=await E(d);if(d.ok&&u){const f=String(u.status||"").toLowerCase();f==="done"?(l=!1,O()):(f==="processing"||f==="queued")&&(l=!1,Ge())}if(l){const f=await _(`/jobs/${b}/start`,{method:"POST"}),w=await E(f);if(!f.ok){alert(w&&w.detail||"Failed to start processing");return}m.status="processing",await Ke(),k(2,"Processing started","processing"),Ge()}}try{await Ra()}catch(l){console.warn(l.message||"Manifest flow unavailable, falling back to legacy flow"),st(!0),await $o(m);return}await mi(),Rt()&&(k(100,"Results ready","completed"),O());const r=j.findIndex(l=>{const d=String(l.parse_status||"").toLowerCase();return d==="done"||d==="failed"});L=r>=0?r:0;const o=P();o?await En(o):U();const s=await _(`/jobs/${b}`),c=await E(s);if(s.ok&&c){(c.status==="processing"||c.status==="queued")&&Rt()&&(c.status="done",c.step="completed",c.progress=100);const l=c.step||c.status||"processing",d=Number.isFinite(c.progress)?c.progress:Jn(c.status,l);k(d,Qn(l),l,c.ocr_backend,c.parse_mode,c),c.status==="processing"||c.status==="queued"?Ge():O()}else Rt()&&(k(100,"Results ready","completed"),O());xn=setInterval(async()=>{if(!m||m.id!==e){Pe();return}await Ra();const l=P(),d=j[L]||null;!me&&l?await En(l):l&&d&&String(d.parse_status||"").toLowerCase()==="done"&&!y.length&&await En(l);const u=await _(`/jobs/${b}`),f=await E(u);if(u.ok&&f){if(Jr(f)){k(100,"Processing appears stalled","failed",f.ocr_backend,f.parse_mode,f),O(),Pe();return}(f.status==="processing"||f.status==="queued")&&Rt()&&(f.status="done",f.step="completed",f.progress=100);const w=f.step||f.status||"processing",g=Number.isFinite(f.progress)?f.progress:Jn(f.status,w);k(g,Qn(w),w,f.ocr_backend,f.parse_mode,f),(f.status==="done"||f.status==="failed")&&(O(),Pe())}else Rt()&&(k(100,"Results ready","completed"),O(),Pe())},1500)}async function Io(){if(!m||!m.id){alert("Open a submission first.");return}if(await cn()){je&&(je.disabled=!0);try{const t=await _(`/evaluator/submissions/${m.id}/finish-review`,{method:"POST"}),n=await E(t);if(!t.ok){alert(n&&n.detail||"Failed to finish review");return}Le=!!(n&&n.can_export),st(!Le),n&&n.summary?ua(n.summary):await ui(),await Ra(),alert(Le?"Review finished. Summary unlocked and exports enabled.":"Review finished, but no transactions were found for export.")}finally{je&&(je.disabled=!In||!In.classList.contains("is-locked"))}}}Nn&&Nn.addEventListener("click",po);Rn&&Rn.addEventListener("click",ho);Me&&Me.addEventListener("click",So);Mr&&Mr.addEventListener("click",da);Br&&we&&Br.addEventListener("click",()=>{we.click()});we&&we.addEventListener("change",()=>{mn()});ee&&ee.addEventListener("input",()=>{_t()});An&&An.addEventListener("input",()=>{le=1,Kn()});Fn&&Fn.addEventListener("input",()=>{ce=1,Vn()});Ct&&Ct.addEventListener("click",e=>{const t=e.target.closest("button.agent-page-btn");if(!t)return;const n=t.dataset.pageNav||"";if(n){n==="prev"&&(le-=1),n==="next"&&(le+=1),Kn();return}const a=Number.parseInt(t.dataset.page||"",10);Number.isFinite(a)&&a>0&&(le=a,Kn())});Ut&&Ut.addEventListener("click",e=>{const t=e.target.closest(".agent-file-remove");if(!t)return;const n=Number.parseInt(t.dataset.index||"-1",10);if(!Number.isFinite(n)||n<0)return;const a=Pt();a.splice(n,1),ci(a),mn()});Ze&&we&&(Ze.addEventListener("dragover",e=>{e.preventDefault(),Ze.classList.add("dragover")}),Ze.addEventListener("dragleave",()=>{Ze.classList.remove("dragover")}),Ze.addEventListener("drop",e=>{e.preventDefault(),Ze.classList.remove("dragover");const t=e.dataTransfer&&e.dataTransfer.files?Array.from(e.dataTransfer.files):[];if(!t.length)return;const a=Pt().concat(t.filter(r=>/\.pdf$/i.test(r.name)));ci(a),mn()}));mn();_t();lt();Ir&&Ir.addEventListener("click",Ke);jt&&jt.addEventListener("click",async()=>{await vo()});at&&(at.addEventListener("change",e=>{const t=e.target.closest("input.evaluator-select-checkbox");if(!t)return;const n=String(t.dataset.submissionId||"").trim();n&&(t.checked?Re.add(n):Re.delete(n),lt())}),at.addEventListener("click",async e=>{const t=e.target.closest("button.agent-page-btn");if(t){const i=t.dataset.evaluatorPageNav||"";if(i){i==="prev"&&(ce-=1),i==="next"&&(ce+=1),Vn();return}const o=Number.parseInt(t.dataset.evaluatorPage||"",10);Number.isFinite(o)&&o>0&&(ce=o,Vn());return}const n=e.target.closest("button[data-action]");if(!n)return;const a=n.dataset.id,r=n.dataset.action;if(!(!a||!r)){if(r==="assign"){await xo(a);return}r==="open"&&(m&&m.id&&m.id!==a&&await cn(),await Mo(a))}}));Q&&v?(V==="agent"&&v!=="agent"&&(v==="credit_evaluator"?window.location.href="/evaluator":window.location.href="/admin"),V==="credit_evaluator"&&v!=="credit_evaluator"&&(v==="agent"?window.location.href="/agent":window.location.href="/admin"),Wn(),v==="agent"?da():v==="credit_evaluator"&&Ke()):(Wn(),ra(!1));Te.addEventListener("change",()=>{!Te.files||!Te.files[0]||fi(Te.files[0])});St.addEventListener("dragover",e=>{e.preventDefault(),St.classList.add("dragover")});St.addEventListener("dragleave",()=>{St.classList.remove("dragover")});St.addEventListener("drop",e=>{if(e.preventDefault(),St.classList.remove("dragover"),!e.dataTransfer.files||!e.dataTransfer.files[0])return;const t=e.dataTransfer.files[0],n=new DataTransfer;n.items.add(t),Te.files=n.files,fi(t)});Mi.addEventListener("click",()=>{rt=null,b=null,Te.value="",Xr.style.display="none",ct=!1,ir(),pa()});Fi.addEventListener("click",()=>{if(!b){alert("Upload a statement first.");return}alert(`OCR job ID: ${b}`)});$e.addEventListener("click",()=>{if(!b){alert("Upload a statement first.");return}if(!He){Ro();return}if(!y.length){alert("OCR is still running or no rows extracted yet.");return}alert("OCR complete. You can review rows and download CSV.")});Ln&&Ln.addEventListener("click",async()=>{await es()});je&&je.addEventListener("click",async()=>{await Io()});Bn&&Bn.addEventListener("click",async()=>{await ts()});Qe&&Qe.addEventListener("click",()=>{na=!jn(),jn()||(K="none",$=!1,J=[]),Ha(),q(),N(),R()});xa.addEventListener("click",()=>{if(!(L<=0)){if(v==="credit_evaluator"&&m){Ja(L-1);return}L-=1,U()}});Ca.addEventListener("click",()=>{if(!(L>=h.length-1)){if(v==="credit_evaluator"&&m){Ja(L+1);return}L+=1,U()}});ke&&ke.addEventListener("change",()=>{const e=Number.parseInt(ke.value,10);if(!(!Number.isFinite(e)||e<0||e>=h.length)){if(v==="credit_evaluator"&&m){Ja(e);return}L=e,U()}});p.addEventListener("load",()=>{p.style.display="block",Wa(),yn(),gn(),R()});p.addEventListener("error",()=>{er()});window.addEventListener("resize",()=>{p&&p.naturalWidth&&Wa(),Hn(),h.length&&R(),Qa(),Tt()});document.addEventListener("click",e=>{e.target.closest(".row-menu")});I.addEventListener("click",e=>{if(D())return;const t=go(e);if(t){if($&&!ie){if(J.length>=4)return;J.push({x:t.x,y:t.y}),q(),R();return}K==="horizontal"&&ii("horizontal",t.y)&&R()}});x&&(x.addEventListener("mousemove",e=>{if(on){const t=e.clientX-Nr,n=e.clientY-Rr;ve=Ar+t,Ee=Fr+n,Qa(),Tt(),R();return}}),x.addEventListener("mouseleave",()=>{bn()}),x.addEventListener("mousedown",e=>{e.button===0&&($||K!=="none"||!h.length||(on=!0,Nr=e.clientX,Rr=e.clientY,Ar=ve,Fr=Ee,x.classList.add("panning"),e.preventDefault()))}));window.addEventListener("mousemove",e=>{if(te&&z){const r=te.pageKey,i=M(r,!0),o=z.getBoundingClientRect();if(!o.height)return;const s=(e.clientY-te.startY)/o.height,c=(te.startLines||[]).slice(),l=te.index;if(l<0||l>=c.length)return;const d=l>0?c[l-1]+et:et,u=l<c.length-1?c[l+1]-et:1-et,f=G(c[l]+s,d,u);c[l]=f,i.horizontal=c,_e(),R(),sa();return}if(!Y||!S)return;const t=Xi();if(!t)return;const n=(e.clientX-Y.startX)/t,a=(Y.startLayout||[]).map(r=>({...r}));kt(Y.pageKey,a),Vi(Y.pageKey,Y.index,n,{redraw:!0,invalidate:!1})});window.addEventListener("mouseup",()=>{if(te){const e=te.pageKey,t=te.guideBefore||Z(M(e,!0)),n=Z(M(e,!0));Bt(t,n)||(ln(e,t),ia(e),qe(e),_e(),N(),oe(),R()),te=null,z&&z.classList.remove("is-resizing"),sa()}if(Y){const e=Y.pageKey,t=Y.guideBefore||Z(M(e,!0)),n=Z(M(e,!0));Bt(t,n)||(ln(e,t),qe(e),_e(),N(),oe(),R()),Y=null,S&&S.classList.remove("is-resizing"),un()}bn()});fr&&fr.addEventListener("click",()=>{yn()});mr&&mr.addEventListener("click",()=>{hi(Yr)});gr&&gr.addEventListener("click",()=>{hi(-Yr)});Ot&&Ot.addEventListener("click",()=>{h.length&&lo("horizontal")});Tn&&Tn.addEventListener("click",()=>{uo()});$n&&$n.addEventListener("click",()=>{fo()});pr&&pr.addEventListener("click",()=>{co()});nt&&nt.addEventListener("click",async()=>{await so()});Mn.length&&Mn.forEach(e=>{e.addEventListener("click",async()=>{const t=e.dataset?String(e.dataset.imageTool||"").trim():"";t&&await Qi(t)})});S&&(S.addEventListener("dragstart",e=>{if(D()){e.preventDefault();return}const t=e.target.closest(".preview-col-item");if(!(!t||!t.dataset||!t.dataset.colKey)){if(Y){e.preventDefault();return}A.sourceKey=t.dataset.colKey,A.targetKey=t.dataset.colKey,H="",e.dataTransfer&&(e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",A.sourceKey)),Je()}}),S.addEventListener("dragover",e=>{if(D()||!A.sourceKey)return;const t=e.target.closest(".preview-col-item");!t||!t.dataset||!t.dataset.colKey||(e.preventDefault(),A.targetKey=t.dataset.colKey,Je())}),S.addEventListener("drop",e=>{if(D()||!A.sourceKey)return;const t=e.target.closest(".preview-col-item"),n=P();n&&t&&t.dataset&&t.dataset.colKey&&Or(n,A.sourceKey,t.dataset.colKey),A={sourceKey:"",targetKey:""},Je()}),S.addEventListener("dragend",()=>{A={sourceKey:"",targetKey:""},Je()}),S.addEventListener("mousedown",e=>{if(D())return;const t=e.target.closest(".preview-col-resizer");if(!t||!t.dataset)return;const n=P();if(!n)return;const a=Number.parseInt(t.dataset.resizeIndex||"",10);if(!Number.isFinite(a))return;const r=Z(M(n,!0));Y={pageKey:n,index:a,startX:e.clientX,startLayout:Be(n,!0).map(i=>({...i})),guideBefore:r},S.classList.add("is-resizing"),e.preventDefault(),e.stopPropagation()}),S.addEventListener("click",e=>{if(D()||e.target.closest(".preview-col-resizer"))return;const t=e.target.closest(".preview-col-item");if(!t||!t.dataset||!t.dataset.colKey)return;const n=P();if(!n)return;const a=t.dataset.colKey;if(!H){H=a,Je();return}if(H===a){H="",Je();return}Or(n,H,a),H="",Je()}));z&&(z.addEventListener("mousedown",e=>{if(D())return;const t=e.target.closest(".preview-row-handle");if(!t||!t.dataset)return;const n=P();if(!n)return;const a=Number.parseInt(t.dataset.rowIndex||"",10);if(!Number.isFinite(a))return;const r=M(n,!0);te={pageKey:n,index:a,startY:e.clientY,startLines:(r.horizontal||[]).slice(),guideBefore:Z(r)},z.classList.add("is-resizing"),e.preventDefault(),e.stopPropagation()}),z.addEventListener("click",e=>{if(D()||e.target.closest(".preview-row-handle")||K!=="horizontal"||!P())return;const n=z.getBoundingClientRect();if(!n.height)return;const a=G((e.clientY-n.top)/n.height,0,1);ii("horizontal",a)&&R()}));Dt&&Dt.addEventListener("click",()=>{!h.length||ie||($=!$,$&&(K="none",N()),$&&yn(),J=[],q(),R())});kn&&kn.addEventListener("click",async()=>{if(!(!b||!h.length||ie)){if(J.length!==4){alert("Select exactly 4 corner points first.");return}try{ie=!0,q();const t=h[L].replace(".png",""),n=await _(`/jobs/${b}/pages/${t}/flatten`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({points:J})});if(!n.ok){const a=await E(n);throw new Error(a&&a.detail||"Flatten failed")}await tr(t),J=[],$=!1,q(),U()}catch(e){alert(e.message||"Flatten failed")}finally{ie=!1,q()}}});Pn&&Pn.addEventListener("click",async()=>{if(!(!b||!h.length||ie))try{ie=!0,q();const t=h[L].replace(".png",""),n=await _(`/jobs/${b}/pages/${t}/flatten/reset`,{method:"POST"});if(!n.ok){const a=await E(n);throw new Error(a&&a.detail||"Reset failed")}await tr(t),J=[],$=!1,q(),U()}catch(e){alert(e.message||"Reset failed")}finally{ie=!1,q()}});function fi(e){if(!e.name.toLowerCase().endsWith(".pdf")){alert("Please upload a PDF file.");return}rt=e,Ti.textContent=e.name,$i.textContent=Li(e.size),Xr.style.display="flex",pa(),No()}async function No(){if(rt){ct=!1,it=!1,He=!1,$e.textContent="Start OCR",Ge(),k(4,"Uploading file...","uploading");try{const e=new FormData;e.append("file",rt),e.append("mode",aa());const t=await _("/jobs",{method:"POST",body:e});if(!t.ok){const a=await E(t);throw new Error(a&&a.detail||"Failed to upload file")}b=(await t.json()).job_id,He=!0,ct=!0,it=!1,$e.textContent="Running OCR...",await Zn(),O(),$e.textContent="OCR Done"}catch(e){O(),He=!1,$e.textContent="Start OCR",k(0,e.message||"Upload failed","failed"),alert(e.message||"Upload failed.")}}}async function Ro(){if(!(!b||He))try{He=!0,ct=!0,it=!1,$e.textContent="Running OCR...",Ge();const e=await _(`/jobs/${b}/start`,{method:"POST"});if(!e.ok){const t=await E(e);throw new Error(t&&t.detail||"Failed to start OCR")}await Zn(),O(),$e.textContent="OCR Done"}catch(e){O(),He=!1,$e.textContent="Start OCR",k(0,e.message||"Failed to start OCR","failed"),alert(e.message||"Failed to start OCR")}}async function Zn(){if(b)for(qa();;){const e=await _(`/jobs/${b}`);if(!e.ok)throw new Error("Failed to read job status");const t=await e.json();if(Jr(t))throw k(100,"Processing appears stalled","failed",t.ocr_backend,t.parse_mode,t),new Error("processing_stale_timeout");const n=t.step||t.status||"processing",a=Number.isFinite(t.progress)?t.progress:Jn(t.status,n),r=t.ocr_backend||null,i=t.parse_mode||aa();if((t.status==="queued"||t.status==="processing")&&(it=!0),t.status==="done"){k(100,"Results ready",n,r,i,t),await gi(),ct&&it&&(ct=!1,it=!1,yi());return}if(t.status==="failed")throw k(a,t.message||"OCR job failed",n,r,i,t),new Error(t.message||"OCR job failed");k(a,Qn(n),n,r,i,t),await rs(1200)}}async function gi(){const e=await _(`/jobs/${b}/cleaned`);if(!e.ok)throw new Error("Failed to read processed pages");if(h=(await e.json()).pages||[],wt={},se={},Ne={},he={},qt={},Xt={},ot={},A={sourceKey:"",targetKey:""},Y=null,H="",te=null,ea={},K="none",ta={},dn=!1,Yn(!1),y=[],re=null,L=0,nn=1,an={},ha(),!h.length){ut([]),U();return}let n=1,a=null,r=null;try{const[i,o]=await Promise.all([_(`/jobs/${b}/parsed`),_(`/jobs/${b}/bounds`)]);i.ok&&(a=await i.json()),o.ok&&(r=await o.json())}catch{a=null,r=null}for(let i=0;i<h.length;i+=1){const o=h[i].replace(".png","");let s=a&&Array.isArray(a[o])?a[o]:null,c=r&&Array.isArray(r[o])?r[o]:null;if(!s){const l=await _(`/jobs/${b}/parsed/${o}`);if(!l.ok)throw new Error(`Failed to read parsed rows for ${o}`);s=await l.json()}if(!c){const l=await _(`/jobs/${b}/rows/${o}/bounds`);c=l.ok?await l.json():[]}wt[o]=Array.isArray(s)?s:[],se[o]=Array.isArray(c)?c:[],wt[o].forEach(l=>{const d=String(n).padStart(3,"0");n+=1;const u={...l,row_key:Ve(),global_row_id:d,page:o,page_row_id:l.row_id};rr(u),y.push(u),Ne[`${o}|${l.row_id}`]=d})}ma(),ut(y),$=!1,J=[],q(),N(),U(),await mi(),R()}async function mi(){if(!(!ue||!fe||!b)){ue.textContent="-",fe.textContent="-";try{let e=null;const t=await _(`/jobs/${b}/account-identity`);if(t.ok)e=await t.json();else{const r=await _(`/jobs/${b}/diagnostics`);if(!r.ok)return;const i=await r.json();e=i&&i.job?i.job:{}}if(!e)return;ue.textContent=(e.account_name||"-").toString(),fe.textContent=(e.account_number||"-").toString(),he={};const n=e.account_name_bbox,a=e.account_number_bbox;n&&n.page&&(he[n.page]=he[n.page]||[],he[n.page].push({...n,kind:"account_name"})),a&&a.page&&(he[a.page]=he[a.page]||[],he[a.page].push({...a,kind:"account_number"}))}catch{ue.textContent="-",fe.textContent="-",he={}}}}function ut(e){if(de.innerHTML="",!e.length){de.innerHTML='<div class="table-empty">No transactions extracted</div>',Jt.textContent="0",Qt.textContent="0",en.textContent="0",tn.textContent="-",Hn();return}e.forEach(t=>{const n=document.createElement("div");n.className="table-row",n.dataset.rowKey=t.row_key,n.dataset.page=t.page,n.dataset.pageRowId=t.page_row_id||"",n.innerHTML="";const a=document.createElement("div");a.className="table-cell",a.textContent=t.global_row_id||"",n.appendChild(a),n.appendChild(Ft(t,"date")),n.appendChild(Ft(t,"description")),n.appendChild(Ft(t,"debit",!0)),n.appendChild(Ft(t,"credit",!0)),n.appendChild(Ft(t,"balance",!0));const r=document.createElement("div");r.className="table-cell table-actions",r.appendChild(Ho(t.row_key)),n.appendChild(r),n.addEventListener("click",()=>{pi(t.row_key)}),de.appendChild(n)}),Zt(e),Hn()}function pi(e){re=e;const t=y.find(a=>a.row_key===e);if(!t)return;const n=h.findIndex(a=>a.replace(".png","")===t.page);n>=0&&(L=n),pn(),U()}function pn(){document.querySelectorAll(".table-row").forEach(e=>{const t=e.dataset.rowKey===re;e.classList.toggle("selected",t)})}function U(){if(dt(),!h.length){Ea.textContent="0/0",xa.disabled=!0,Ca.disabled=!0,Aa(),er();return}const t=h[L].replace(".png","");D()||(Va(t),ni(t,{redraw:!1,invalidate:!1})),Ea.textContent=`${L+1}/${h.length}`,xa.disabled=L===0,Ca.disabled=L>=h.length-1,Aa(),Jo(t);const n=y.find(a=>a.row_key===re);n&&n.page!==t&&pn(),Qo(),q(),ca(),N(),gn()}function R(){const e=I.getContext("2d"),t=h[L];if(!e||!t||!p.naturalWidth){Fa();return}const n=I.parentElement;if(!n){Fa();return}const a=n.getBoundingClientRect(),r=hn(p),i=window.devicePixelRatio||1,o=r.left-a.left,s=r.top-a.top,c=o+r.width/2+ve,l=s+r.height/2+Ee,d=Math.max(1,Math.round(r.width*W)),u=Math.max(1,Math.round(r.height*W)),f=Math.round(c-d/2),w=Math.round(l-u/2);I.width=Math.round(d*i),I.height=Math.round(u*i),I.style.width=`${d}px`,I.style.height=`${u}px`,I.style.left=`${f}px`,I.style.top=`${w}px`,e.setTransform(i,0,0,i,0,0),ti(f,d),e.clearRect(0,0,I.width,I.height);const g=t.replace(".png",""),B=y.find(T=>T.row_key===re);if(B&&B.page===g&&B.global_row_id){const T=Po(g,B);if(T){const gt=T.x1*d,mt=T.y1*u,wn=T.x2*d,pe=T.y2*u,$t=Math.max(1,wn-gt),X=Math.max(1,pe-mt);e.fillStyle="rgba(34, 197, 94, 0.18)",e.fillRect(gt,mt,$t,X),e.strokeStyle="rgba(22, 163, 74, 0.9)",e.lineWidth=1,e.strokeRect(gt,mt,$t,X)}}mo(e,g,d,u),$&&Ao(e)}function hn(e){const t=x||e.parentElement,n=t?t.getBoundingClientRect():e.getBoundingClientRect(),a=t?t.clientWidth:n.width,r=t?t.clientHeight:n.height,i=e.naturalWidth||a,o=e.naturalHeight||r;if(!a||!r||!i||!o)return n;const s=a/r,c=i/o;let l=a,d=r,u=0,f=0;return c>s?(l=a,d=a/c,f=(r-d)/2):(d=r,l=r*c,u=(a-l)/2),{left:n.left+u,top:n.top+f,width:l,height:d,right:n.left+u+l,bottom:n.top+f+d}}function Aa(){if(!ke)return;ke.options.length!==h.length+1&&(ke.innerHTML='<option value="">Page</option>',h.forEach((t,n)=>{const a=document.createElement("option");a.value=String(n),a.textContent=`Page ${n+1}`,ke.appendChild(a)})),ke.disabled=h.length===0,ke.value=h.length?String(L):""}function Tt(){const e=`translate(${Math.round(ve)}px, ${Math.round(Ee)}px) scale(${W.toFixed(3)})`;p.style.transform=e,I.style.transform="none",yr&&(yr.textContent=`${Math.round(W*100)}%`),x&&(x.classList.toggle("pannable",W>fa()+.001&&!$&&K==="none"),on||x.classList.remove("panning"))}function yn(){const e=fa();W=Math.max(Oa,Math.min(Ua,e)),ve=0,Ee=0,bn(),Tt(),h.length&&p.naturalWidth&&R()}function Qa(){const e=fa();if(!x||!p.naturalWidth||W<e-.001){ve=0,Ee=0;return}const t=hn(p),n=Math.max(0,(t.width*W-t.width)/2),a=Math.max(0,(t.height*W-t.height)/2);ve=G(ve,-n,n),Ee=G(Ee,-a,a)}function bn(){on&&(on=!1,x&&x.classList.remove("panning"))}function fa(){if(!x||!p.naturalWidth)return 1;const e=hn(p),t=x.clientWidth||1,n=x.clientHeight||1;if(e.width<=0||e.height<=0)return 1;const a=Math.min(t/e.width,n/e.height);return Math.max(Oa,Math.min(Ua,a))}function G(e,t,n){return Math.max(t,Math.min(n,e))}function hi(e){if($||!h.length||!p.naturalWidth)return;const t=fa(),n=G(W+e,Oa,Ua);Math.abs(n-W)<.001||(W=n,W<t-.001&&(ve=0,Ee=0),Qa(),Tt(),R())}function Fa(){const e=I.getContext("2d");e&&e.clearRect(0,0,I.width,I.height)}function er(){p.removeAttribute("src"),p.removeAttribute("data-src"),p.removeAttribute("data-loaded-src"),p.removeAttribute("data-requested-src"),p.style.display="none",Wi(),yn(),I.style.left="0px",I.style.top="0px",Ea.textContent="0/0",Fa(),q(),ca(),_e(),un(),sa(),gn()}function Ao(e){const t=J.map(n=>({x:n.x*I.width,y:n.y*I.height}));if(t.length>1){e.strokeStyle="#2e4bff",e.lineWidth=1.6,e.beginPath(),e.moveTo(t[0].x,t[0].y);for(let n=1;n<t.length;n+=1)e.lineTo(t[n].x,t[n].y);t.length===4&&e.closePath(),e.stroke()}t.forEach((n,a)=>{e.fillStyle="#2e4bff",e.beginPath(),e.arc(n.x,n.y,4,0,Math.PI*2),e.fill(),e.fillStyle="#1f2937",e.font='600 10px "Manrope", sans-serif',e.fillText(String(a+1),n.x+6,n.y-6)})}function q(){const e=D();Dt&&(Dt.textContent=$?"Cancel":"Flatten",Dt.disabled=ie||!h.length||e),kn&&(kn.disabled=ie||!$||J.length!==4||e),Pn&&(Pn.disabled=ie||!h.length||e),$&&bn(),Tt(),gn()}async function tr(e){const[t,n]=await Promise.all([_(`/jobs/${b}/parsed/${e}`),_(`/jobs/${b}/rows/${e}/bounds`)]);if(an[e]=(an[e]||0)+1,Zo(e),!t.ok){se[e]=[],U();return}const a=await t.json(),r=n.ok?await n.json():[],i=y.filter(c=>c.page===e&&!c.global_row_id),o=y.filter(c=>c.page!==e),s=[];a.forEach(c=>{const l={...c,row_key:Ve(),global_row_id:c.row_id||"",page:e,page_row_id:c.row_id||""};rr(l),s.push(l)}),y=[...o,...s,...i],se[e]=Array.isArray(r)?r:[],ni(e,{redraw:!1,invalidate:!1}),ma(),ut(y)}function yi(){br&&br.scrollIntoView({behavior:"smooth",block:"start"})}function bi(e){return{total_transactions:e.length,debit_transactions:Ye(e,"debit"),credit_transactions:Ye(e,"credit"),adb:wi(e),monthly:ga(e).map(t=>({month:t.monthLabel,debit:t.debit,credit:t.credit,avg_debit:t.avgDebit,avg_credit:t.avgCredit,adb:t.adb}))}}function wi(e){const t=vi(e);if(!t.length)return null;let n=0,a=0;for(let r=0;r<t.length;r+=1){const i=t[r],o=r<t.length-1?t[r+1].date:Si(i.date,1),s=Math.max(1,_i(i.date,o));n+=i.balance*s,a+=s}return a?n/a:null}function Fo(e){const t=wi(e);return Number.isFinite(t)?zo(t,null,null,!0):"-"}function vi(e){const t=[];if(e.forEach((a,r)=>{const i=Xe(a.balance||""),o=nr(a.date||"");!Number.isFinite(i)||!o||t.push({idx:r,date:o,balance:i})}),!t.length)return[];t.sort((a,r)=>{const i=a.date.getTime()-r.date.getTime();return i!==0?i:a.idx-r.idx});const n=[];return t.forEach(a=>{const r=Do(a.date);if(n.length&&n[n.length-1].key===r){n[n.length-1].balance=a.balance;return}n.push({key:r,date:a.date,balance:a.balance})}),n}function ga(e){const t=[];if(e.forEach((o,s)=>{const c=nr(o.date||"");if(!c)return;const l=za(o,"debit"),d=za(o,"credit");t.push({idx:s,date:c,debit:l,credit:d})}),!t.length)return[];t.sort((o,s)=>{const c=o.date.getTime()-s.date.getTime();return c!==0?c:o.idx-s.idx});const n=new Map,a=t[0].date,r=t[t.length-1].date;Uo(n,a,r),t.forEach(o=>{const s=n.get(ar(o.date));if(s){if(Number.isFinite(o.debit)){const c=Math.abs(o.debit);c>0&&(s.debit+=c,s.debitCount+=1)}if(Number.isFinite(o.credit)){const c=Math.abs(o.credit);c>0&&(s.credit+=c,s.creditCount+=1)}}});const i=vi(e);for(let o=0;o<i.length;o+=1){const s=i[o],c=o<i.length-1?i[o+1].date:Si(s.date,1);jo(n,s.date,c,s.balance)}return Array.from(n.values()).filter(o=>o.days>0||o.debit>0||o.credit>0).map(o=>({monthLabel:o.label,debit:o.debit,credit:o.credit,avgDebit:o.debitCount>0?o.debit/o.debitCount:0,avgCredit:o.creditCount>0?o.credit/o.creditCount:0,adb:o.days>0?o.weightedBalance/o.days:0}))}function zo(e,t,n,a=!1){if(!Number.isFinite(e)){const i=Xe("".trim());if(!Number.isFinite(i))return"-";const o=a?Math.abs(i):i;return F(o,a)}const r=a?Math.abs(e):e;return F(r,a)}function F(e,t=!1){const n=new Intl.NumberFormat("en-PH",{minimumFractionDigits:2,maximumFractionDigits:2});return`${t?"":e<0?"-":"+"}₱${n.format(Math.abs(e))}`}function Xe(e){if(e==null)return NaN;const t=String(e).trim();if(!t)return NaN;const n=/\(\s*[\d,.\-]+\s*\)/.test(t),a=t.match(/-?\d[\d,]*(?:\.\d+)?/g)||[];if(!a.length)return NaN;const r=a.filter(c=>/\.\d{1,}$/.test(c)||/,\d{3}/.test(c)),i=(r.length?r:a).filter(c=>{const l=c.replace(/[^0-9]/g,"");return!c.includes(".")&&l.length>=11?!1:l.length>0});if(!i.length)return NaN;const o=i[i.length-1].replace(/,/g,""),s=Number.parseFloat(o);return Number.isFinite(s)?n&&s>0?-s:s:NaN}function nr(e){const t=String(e||"").trim().toUpperCase().replace(/\s+/g," ");if(!t)return null;const n=t.split(",")[0].trim(),a={JAN:1,FEB:2,MAR:3,APR:4,MAY:5,JUN:6,JUL:7,AUG:8,SEP:9,OCT:10,NOV:11,DEC:12};let r=n.match(/^(\d{4})\/(\d{1,2})\/(\d{1,2})$/);if(r||(r=n.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/),r))return At(Number(r[1]),Number(r[2]),Number(r[3]));if(r=n.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2,4})$/),r)return At(_a(r[3]),Number(r[1]),Number(r[2]));if(r=n.match(/^(\d{1,2})-(\d{1,2})-(\d{2,4})$/),r)return At(_a(r[3]),Number(r[2]),Number(r[1]));if(r=n.match(/^(\d{1,2})\s+([A-Z]{3,9})\s+(\d{2,4})$/),r){const i=a[r[2].slice(0,3)];return i?At(_a(r[3]),i,Number(r[1])):null}return null}function _a(e){const t=Number(e);return Number.isFinite(t)?t>=100?t:t<=79?2e3+t:1900+t:NaN}function At(e,t,n){if(!Number.isFinite(e)||!Number.isFinite(t)||!Number.isFinite(n)||t<1||t>12||n<1||n>31)return null;const a=new Date(Date.UTC(e,t-1,n));return a.getUTCFullYear()!==e||a.getUTCMonth()!==t-1||a.getUTCDate()!==n?null:a}function _i(e,t){return Math.round((t.getTime()-e.getTime())/864e5)}function Si(e,t){return new Date(e.getTime()+t*24*60*60*1e3)}function Do(e){const t=e.getUTCFullYear(),n=String(e.getUTCMonth()+1).padStart(2,"0"),a=String(e.getUTCDate()).padStart(2,"0");return`${t}-${n}-${a}`}function ar(e){const t=e.getUTCFullYear(),n=String(e.getUTCMonth()+1).padStart(2,"0");return`${t}-${n}`}function Oo(e){return e.toLocaleDateString("en-US",{month:"short",year:"numeric",timeZone:"UTC"})}function Uo(e,t,n){let a=new Date(Date.UTC(t.getUTCFullYear(),t.getUTCMonth(),1));const r=new Date(Date.UTC(n.getUTCFullYear(),n.getUTCMonth(),1));for(;a.getTime()<=r.getTime();){const i=ar(a);e.set(i,{label:Oo(a),debit:0,credit:0,debitCount:0,creditCount:0,weightedBalance:0,days:0}),a=new Date(Date.UTC(a.getUTCFullYear(),a.getUTCMonth()+1,1))}}function jo(e,t,n,a){if(!Number.isFinite(a))return;let r=new Date(t.getTime());for(;r.getTime()<n.getTime();){const i=new Date(Date.UTC(r.getUTCFullYear(),r.getUTCMonth(),1)),o=new Date(Date.UTC(i.getUTCFullYear(),i.getUTCMonth()+1,1)),s=n.getTime()<o.getTime()?n:o,c=Math.max(1,_i(r,s)),l=e.get(ar(r));l&&(l.weightedBalance+=a*c,l.days+=c),r=s}}function Ft(e,t,n=!1){const a=document.createElement("div");a.className=`table-cell ${n?"amount-input-cell":""}`,a.dataset.rowKey=e.row_key,a.dataset.field=t;const r=document.createElement("input");r.type="text",r.className=`table-input table-input-${t}`,r.value=be(e,t),r.dataset.rowKey=e.row_key,r.dataset.field=t;const o=!!e.global_row_id&&(t==="debit"||t==="credit");return r.placeholder=o?"":t.toUpperCase(),r.addEventListener("click",s=>{s.stopPropagation()}),r.addEventListener("input",()=>{e[t]=r.value.trim(),oe(),Zt(y)}),r.addEventListener("focus",()=>{document.querySelectorAll(".table-cell.active-cell").forEach(s=>s.classList.remove("active-cell")),a.classList.add("active-cell"),re!==e.row_key&&pi(e.row_key)}),r.addEventListener("blur",()=>{a.classList.remove("active-cell")}),r.addEventListener("keydown",s=>{qo(s,e.row_key,t)}),r.addEventListener("blur",()=>{const s=Ue(t,r.value);e[t]=s,r.value=s,oe(),Zt(y)}),r.addEventListener("change",()=>{const s=Ue(t,r.value);e[t]=s,oe(),Zt(y)}),a.appendChild(r),a}function Ho(e){const t=document.createElement("div");return t.className="row-actions-inline",t.appendChild(qr("fa-solid fa-plus","Insert row","insert",()=>{Wo(e)})),t.appendChild(qr("fa-solid fa-trash","Delete row","delete",()=>{Go(e)})),t}function qr(e,t,n,a){const r=document.createElement("button");return r.type="button",r.className=`row-action row-action-${n}`,r.setAttribute("aria-label",t),r.title=t,r.innerHTML=`<i class="${e}" aria-hidden="true"></i>`,r.addEventListener("click",i=>{i.stopPropagation(),a()}),r}function Wo(e){const t=y.findIndex(r=>r.row_key===e);if(t<0)return;const n=y[t]||{},a={row_key:Ve(),global_row_id:"",row_id:"",date:"",description:"",debit:"",credit:"",balance:"",page:n.page||P(),page_row_id:""};y.splice(t+1,0,a),oe(),ma(),ut(y),pn(),U()}function Go(e){const t=y.findIndex(n=>n.row_key===e);if(!(t<0)){if(y.splice(t,1),oe(),ma(),!y.length)re=null;else if(re===e){const n=y[Math.min(t,y.length-1)];re=n?n.row_key:null}ut(y),pn(),U()}}function ma(){Ne={},he={};let e=1;y.forEach(t=>{t.page||(t.page=P()),t.row_key||(t.row_key=Ve()),t.page_row_id?(t.global_row_id=String(e).padStart(3,"0"),e+=1):t.global_row_id="",t.page&&t.page_row_id&&(Ne[`${t.page}|${t.page_row_id}`]=t.global_row_id)})}function qo(e,t,n){if(!t||!n)return;const a=La.indexOf(n);if(!(a<0)){if(e.key==="Enter"){e.preventDefault(),zt(t,a,1,0);return}if(e.key==="ArrowDown"){e.preventDefault(),zt(t,a,1,0);return}if(e.key==="ArrowUp"){e.preventDefault(),zt(t,a,-1,0);return}if(e.key==="ArrowRight"&&e.altKey){e.preventDefault(),zt(t,a,0,1);return}e.key==="ArrowLeft"&&e.altKey&&(e.preventDefault(),zt(t,a,0,-1))}}function zt(e,t,n,a){const r=y.findIndex(u=>u.row_key===e);if(r<0)return;const i=Math.max(0,Math.min(y.length-1,r+n)),o=Math.max(0,Math.min(La.length-1,t+a)),s=y[i].row_key,c=La[o],l=`.table-input[data-row-key="${s}"][data-field="${c}"]`,d=document.querySelector(l);d&&(d.focus(),typeof d.select=="function"&&d.select())}function Ve(){const e=nn;return nn+=1,`row_${e}`}function P(){return h.length?h[Math.max(0,Math.min(L,h.length-1))].replace(".png",""):""}function Zt(e){v==="credit_evaluator"&&m||(Jt.textContent=String(e.length),Qt.textContent=String(Ye(e,"debit")),en.textContent=String(Ye(e,"credit")),tn.textContent=e.length?Fo(e):"-",xi(e))}function xi(e){const t=document.getElementById("monthlySummaryBody"),n=document.querySelector(".monthly-summary-wrap");if(!t)return;const a=ga(e);if(!a.length){n&&n.classList.add("is-empty"),t.innerHTML='<tr><td class="monthly-empty" colspan="6">No monthly data</td></tr>';return}n&&n.classList.remove("is-empty"),t.innerHTML=a.map(r=>`<tr>
      <td>${C(r.monthLabel)}</td>
      <td>${C(F(Math.abs(r.debit),!0))}</td>
      <td>${C(F(Math.abs(r.credit),!0))}</td>
      <td>${C(F(Math.abs(r.avgDebit),!0))}</td>
      <td>${C(F(Math.abs(r.avgCredit),!0))}</td>
      <td>${C(F(r.adb,!0))}</td>
    </tr>`).join("")}function Ye(e,t){return e.reduce((n,a)=>{const r=za(a,t);return Number.isFinite(r)&&Math.abs(r)>0?n+1:n},0)}function za(e,t){const n=Xe(e&&e[t]);if(!Number.isFinite(n))return NaN;const a=Math.abs(n);if(a>=1e9)return NaN;const r=Xe(e&&e.balance);return Number.isFinite(r)&&Math.abs(r)>0&&a>Math.abs(r)*50?NaN:n}function be(e,t){return Ue(t,e[t]||"")}function rr(e){e.date=Ue("date",e.date||""),e.description=Ue("description",e.description||""),e.debit=Ue("debit",e.debit||""),e.credit=Ue("credit",e.credit||""),e.balance=Ue("balance",e.balance||"")}function Ue(e,t){const n=String(t||"").trim();if(!n)return"";if(e==="date"){const a=nr(n);if(!a)return n;const r=String(a.getUTCMonth()+1).padStart(2,"0"),i=String(a.getUTCDate()).padStart(2,"0"),o=String(a.getUTCFullYear());return`${r}/${i}/${o}`}if(e==="debit"||e==="credit"||e==="balance"){const a=Xe(n);return Number.isFinite(a)?new Intl.NumberFormat("en-US",{minimumFractionDigits:2,maximumFractionDigits:2}).format(a):n}return n}function C(e){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function k(e,t,n,a=null,r=null,i=null){r!=null&&Hi(r);const o=Math.max(0,Math.min(100,Math.round(e))),s=String(i&&i.status||n||"").toLowerCase(),c=`${s}|${String(n||"")}|${o}`;if(c!==Ma&&(Ma=c,zn=Date.now(),On=!1),Dn=s||Dn,Ii.style.width=`${o}%`,Ni.textContent=`${o}%`,Ri.textContent=t,Ai.textContent=`Step: ${Qn(n)}`,or){const l=(r||"text").toString().toUpperCase(),d=l==="OCR"||String(n||"").toLowerCase()==="section_ocr";or.textContent=`Mode: ${l}${d?` | OCR Model: ${a||"-"}`:""}`}if(sr&&lr&&cr&&dr&&ur){const l=i&&i.profile_analyzer_model?i.profile_analyzer_model:"-",d=i&&i.profile_analyzer_result?i.profile_analyzer_result:"idle",u=i&&i.profile_analyzer_reason?i.profile_analyzer_reason:"-",f=i&&i.profile_selected_after_analyzer?i.profile_selected_after_analyzer:"-",w=!!(i&&i.profile_analyzer_triggered);sr.textContent=`AI Analyzer: ${w?Ko(d):"Idle"}`,cr.textContent=`Model: ${l}`,dr.textContent=`Profile: ${f}`,ur.textContent=`Reason: ${u}`,lr.classList.toggle("is-hidden",!w)}tt&&!rn&&(tt.textContent="Elapsed: 00:00")}function Xo(e,t="tesseract",n="ocr"){if(!e||typeof e!="object")return;const a=String(e.reason||"").toLowerCase(),r=!!e.triggered||a==="matched_existing_profile"||a==="no_ocr_profiles_sampled"||a==="no_text_or_ocr_profiles_sampled",i=String(e.result||"").trim()||(a==="matched_existing_profile"?"matched":"skipped");let o="Profile check completed";a==="matched_existing_profile"?o=`Profile matched${e.profile_name?` (${e.profile_name})`:""}`:i.toLowerCase()==="applied"?o="AI profile created and applied":i.toLowerCase()==="rejected"?o="AI profile proposal rejected by validation":i.toLowerCase()==="failed"?o=`AI profile analyzer failed${e.reason?` (${e.reason})`:""}`:a==="no_ocr_profiles_sampled"&&(o="No OCR text sampled for profile analysis");const s={profile_analyzer_triggered:r,profile_analyzer_provider:e.provider||"-",profile_analyzer_model:e.model||"-",profile_analyzer_result:i,profile_analyzer_reason:e.reason||"-",profile_selected_after_analyzer:e.profile_name||null};k(100,o,"profile_analyzer",t,n,s)}function Ge(){rn=Date.now(),Da(),Ie&&clearInterval(Ie),Ie=setInterval(Da,1e3)}function O(){Ie&&(clearInterval(Ie),Ie=null),Da()}function Yo(){rn=0,Ie&&(clearInterval(Ie),Ie=null),tt&&(tt.textContent="Elapsed: 00:00")}function Da(){if(!tt)return;if(!rn){tt.textContent="Elapsed: 00:00",Dr();return}const e=Math.max(0,Math.floor((Date.now()-rn)/1e3)),t=String(Math.floor(e/60)).padStart(2,"0"),n=String(e%60).padStart(2,"0");tt.textContent=`Elapsed: ${t}:${n}`,Dr()}function ir(){k(0,"Waiting for upload","queued",null)}function Jn(e,t){return t==="draft_queued"?2:t==="draft_pdf_to_images"?35:t==="draft_image_cleaning"?80:t==="ready_for_edit"||e==="draft"?100:e==="queued"||t==="queued"||e==="for_review"||t==="for_review"?0:e==="summary_generated"||e==="done"?100:t==="pdf_to_images"?15:t==="image_cleaning"?40:t==="text_extraction"?65:t==="page_ocr"||t==="page_text"?80:t==="parsing"||t==="saving_results"?92:10}function Qn(e){const t=String(e||"").toLowerCase();return t==="queued"?"Queued":t==="for_review"?"For Review":t==="draft_queued"?"Draft queued":t==="draft_pdf_to_images"?"Preparing preview pages":t==="draft_image_cleaning"?"Cleaning draft pages":t==="ready_for_edit"?"Ready for edit":t==="uploading"?"Uploading":t==="pdf_to_images"?"Converting PDF to images":t==="image_cleaning"?"Cleaning page images":t==="text_extraction"?"Extracting PDF text":t==="account_identity_ai"?"Extracting account identity":t==="profile_analyzer"?"Analyzing unknown bank structure":t==="page_ocr"?"Running OCR per page":t==="section_ocr"?"OCR in selected sections":t==="page_text"?"Parsing text per page":t==="saving_results"?"Saving results":t==="parsing"?"Parsing extracted rows":t==="completed"||t==="done"?"Completed":t==="summary_generated"?"Summary Generated":t==="failed"?"Failed":"Processing"}function Ko(e){const t=String(e||"").trim();return t?t.charAt(0).toUpperCase()+t.slice(1):""}function Vo(e){const t=String(e||"").trim();return t?t.replace(/_/g," ").replace(/\b\w/g,n=>n.toUpperCase()):"-"}function pa(){ft(),ne&&(clearInterval(ne),ne=null),Oe=0,Jt.textContent="0",Qt.textContent="0",en.textContent="0",tn.textContent="-",ue&&(ue.textContent="-"),fe&&(fe.textContent="-"),de.innerHTML="",h=[],y=[],wt={},se={},Ne={},qt={},Xt={},ot={},A={sourceKey:"",targetKey:""},Y=null,H="",te=null,ea={},K="none",ta={},dn=!1,vt="text",na=!1,Yn(!1),re=null,L=0,nn=1,an={},ha(),j=[],ze={total_pages:0,parsed_pages:0,reviewed_pages:0,percent:0},Le=!1,me="",We="pending",Wt=null,ge=!1,Lt=0,pt=null,Pe(),dt(),$=!1,J=[],ie=!1,He=!1,$e.textContent="Start OCR",Yo(),ct=!1,it=!1,Zt([]),st(v==="credit_evaluator"),q(),N(),U()}function Ci(e){return`/jobs/${b}/preview/${e}?v=${an[e]||0}`}function ha(){Ht.clear();for(const e of Et.values())URL.revokeObjectURL(e);Et.clear()}function Zo(e){const t=`/preview/${e}?`;for(const[n,a]of Et.entries())n.includes(t)&&(URL.revokeObjectURL(a),Et.delete(n),Ht.delete(n))}async function Ei(e){const t=Et.get(e);if(t)return t;const n=await _(e);if(!n.ok)throw new Error(`Preview load failed (${n.status})`);const a=await n.blob(),r=URL.createObjectURL(a);return Et.set(e,r),r}async function Jo(e){if(!b)return;const t=Ci(e);if(p.dataset.loadedSrc===t&&p.src){p.style.display="block",Wa(),R(),Tt();return}yn(),p.style.display="none",p.dataset.requestedSrc=t;try{const n=await Ei(t);if(p.dataset.requestedSrc!==t)return;p.dataset.loadedSrc=t,p.src=n}catch(n){p.dataset.requestedSrc===t&&er(),console.warn(n.message||"Failed to load preview image")}}function Sa(e){if(!b||e<0||e>=h.length)return;const t=h[e].replace(".png",""),n=Ci(t);Ht.has(n)||(Ht.add(n),Ei(n).catch(()=>{Ht.delete(n)}))}function Qo(){Sa(L+1),Sa(L-1),Sa(L+2)}function Li(e){if(!e)return"0 Bytes";const t=["Bytes","KB","MB","GB"],n=Math.floor(Math.log(e)/Math.log(1024));return`${(e/Math.pow(1024,n)).toFixed(1)} ${t[n]}`}async function E(e){try{return await e.json()}catch{return null}}async function Bi(){if(!m||!m.id)return;const e=await _(`/evaluator/submissions/${m.id}/mark-summary-generated`,{method:"POST"}),t=await E(e);if(!e.ok)throw new Error(t&&t.detail||"Failed to mark summary generated");m=t,await Ke()}async function ki(){if(!(v==="credit_evaluator"&&m&&m.id))return null;const e=m.id,t=await _(`/evaluator/submissions/${e}/review-status`),n=await E(t);if(!t.ok)throw new Error(n&&n.detail||"Failed to check review status");if(!n.can_export)throw new Error("Review all pages to enable export.");const a=await _(`/evaluator/submissions/${e}/pages`),r=await E(a);if(!a.ok)throw new Error(r&&r.detail||"Failed to load page manifest");const i=Array.isArray(r.pages)?r.pages:[],o=[];for(const d of i){const u=d&&d.page_key?d.page_key:"";if(!u)continue;const f=await _(`/evaluator/submissions/${e}/pages/${u}`),w=await E(f);if(!f.ok)continue;(Array.isArray(w.rows)?w.rows:[]).forEach((B,T)=>{o.push({row_key:Ve(),global_row_id:String(B.row_id||T+1).padStart(3,"0"),row_id:String(B.row_id||T+1).padStart(3,"0"),date:B.date||"",description:B.description||"",debit:B.debit!=null?String(B.debit):"",credit:B.credit!=null?String(B.credit):"",balance:B.balance!=null?String(B.balance):"",page:u,page_row_id:String(B.row_id||T+1).padStart(3,"0")})})}const s=await _(`/evaluator/submissions/${e}`),c=await E(s),l=s.ok&&c&&c.summary||null;return{rows:o,summary:l}}async function es(){let e=y.slice(),t=null;if(v==="credit_evaluator"&&m&&m.id)try{const u=await ki();e=u&&Array.isArray(u.rows)?u.rows:[],t=u?u.summary:null}catch(u){alert(u&&u.message||"Export blocked");return}if(!e.length){alert("No extracted rows to export yet.");return}if(!window.jspdf||typeof window.jspdf.jsPDF!="function"){alert("PDF library is not loaded.");return}const n=new window.jspdf.jsPDF({orientation:"portrait",unit:"pt",format:"a4"}),a=40;let r=42;n.setFont("helvetica","bold"),n.setFontSize(14),n.text("Account Summary",a,r),r+=16,n.setFont("helvetica","normal"),n.setFontSize(9);const i=new Date;n.text(`Generated: ${i.toLocaleDateString()} ${i.toLocaleTimeString()}`,a,r),r+=14;const o=t||bi(e),s=[["Account Name",xe((ue&&ue.textContent?ue.textContent:"-").trim())],["Account Number",xe((fe&&fe.textContent?fe.textContent:"-").trim())],["Total Transactions",xe(String(o.total_transactions||e.length))],["Debit Transactions",xe(String(o.debit_transactions||Ye(e,"debit")))],["Credit Transactions",xe(String(o.credit_transactions||Ye(e,"credit")))],["Average Daily Balance (ADB)",as(o.adb)]];typeof n.autoTable=="function"?(n.autoTable({startY:r,theme:"grid",margin:{left:a,right:40},head:[[{content:"Account Summary",colSpan:2,styles:{halign:"left"}}]],body:s,styles:{font:"helvetica",fontSize:9,cellPadding:5},headStyles:{fillColor:[245,246,250],textColor:[33,37,41],fontStyle:"bold"},columnStyles:{0:{cellWidth:180}}}),r=n.lastAutoTable.finalY+16):(s.forEach(([u,f])=>{n.text(`${u}: ${f}`,a,r),r+=12}),r+=8);const c=Array.isArray(o.monthly)&&o.monthly.length?o.monthly.map(u=>({monthLabel:u.month||u.monthLabel,debit:Number(u.debit||0),credit:Number(u.credit||0),avgDebit:Number(u.avg_debit||u.avgDebit||0),avgCredit:Number(u.avg_credit||u.avgCredit||0),adb:Number(u.adb||0)})):ga(e);n.setFont("helvetica","bold"),n.setFontSize(11),n.text("Monthly Summary",a,r),r+=8;const l=c.length?c.map(u=>[xe(u.monthLabel),Fe(u.debit,!0),Fe(u.credit,!0),Fe(u.avgDebit,!0),Fe(u.avgCredit,!0),Fe(u.adb,!0)]):[["No monthly data","-","-","-","-","-"]];typeof n.autoTable=="function"?(n.autoTable({startY:r,theme:"grid",margin:{left:a,right:40},head:[["Month","Debit","Credit","Avg Debit","Avg Credit","ADB"]],body:l,styles:{font:"helvetica",fontSize:8.5,cellPadding:4},headStyles:{fillColor:[245,246,250],textColor:[33,37,41],fontStyle:"bold"},columnStyles:{0:{cellWidth:108},1:{cellWidth:88,halign:"right"},2:{cellWidth:88,halign:"right"},3:{cellWidth:95,halign:"right"},4:{cellWidth:95,halign:"right"},5:{cellWidth:95,halign:"right"}}}),r=n.lastAutoTable.finalY+16):(l.forEach(([u,f,w,g,B,T])=>{n.text(`${u}: ${f} / ${w} / ${g} / ${B} / ${T}`,a,r),r+=12}),r+=8),n.setFont("helvetica","bold"),n.setFontSize(12),n.text("Transactions",a,r),r+=10;const d=e.map((u,f)=>[String(u.global_row_id||u.row_id||f+1),xe(be(u,"date")||""),xe(be(u,"description")||""),Fe(be(u,"debit")||""),Fe(be(u,"credit")||""),Fe(be(u,"balance")||"")]);if(typeof n.autoTable=="function")n.autoTable({startY:r,theme:"grid",margin:{left:a,right:40},head:[["#","Date","Description","Debit","Credit","Balance"]],body:d,styles:{font:"helvetica",fontSize:8.5,cellPadding:4,overflow:"linebreak"},headStyles:{fillColor:[245,246,250],textColor:[33,37,41],fontStyle:"bold"},columnStyles:{0:{cellWidth:34,halign:"center"},1:{cellWidth:70},2:{cellWidth:170},3:{cellWidth:78,halign:"right"},4:{cellWidth:78,halign:"right"},5:{cellWidth:88,halign:"right"}}});else{const u=d.map(f=>f.join(" | "));n.setFont("helvetica","normal"),n.setFontSize(8),u.forEach(f=>{r>780&&(n.addPage(),r=42),n.text(f,a,r),r+=10})}if(n.save(ns()),v==="credit_evaluator"&&m&&m.id)try{await Bi()}catch{}}async function ts(){let e=y.slice(),t=null;if(v==="credit_evaluator"&&m&&m.id)try{const f=await ki();e=f&&Array.isArray(f.rows)?f.rows:[],t=f?f.summary:null}catch(f){alert(f&&f.message||"Export blocked");return}if(!e.length){alert("No extracted rows to export yet.");return}if(!window.XLSX||!window.XLSX.utils||typeof window.XLSX.writeFile!="function"){alert("Excel export library is not loaded.");return}const n=window.XLSX.utils.book_new(),a=t||bi(e),r=[["Account Name",(ue&&ue.textContent?ue.textContent:"-").trim()],["Account Number",(fe&&fe.textContent?fe.textContent:"-").trim()],["Total Transactions",String(a.total_transactions||e.length)],["Debit Transactions",String(a.debit_transactions||Ye(e,"debit"))],["Credit Transactions",String(a.credit_transactions||Ye(e,"credit"))],["Average Daily Balance (ADB)",F(Number(a.adb||0),!0)]],i=window.XLSX.utils.aoa_to_sheet([["Account Summary",""],...r]);window.XLSX.utils.book_append_sheet(n,i,"Summary");const o=Array.isArray(a.monthly)&&a.monthly.length?a.monthly.map(f=>({monthLabel:f.month||f.monthLabel,debit:Number(f.debit||0),credit:Number(f.credit||0),avgDebit:Number(f.avg_debit||f.avgDebit||0),avgCredit:Number(f.avg_credit||f.avgCredit||0),adb:Number(f.adb||0)})):ga(e),s=o.length?o.map(f=>[f.monthLabel,F(Math.abs(f.debit),!0),F(Math.abs(f.credit),!0),F(Math.abs(f.avgDebit),!0),F(Math.abs(f.avgCredit),!0),F(f.adb,!0)]):[["No monthly data","-","-","-","-","-"]],c=window.XLSX.utils.aoa_to_sheet([["Month","Debit","Credit","Avg Debit","Avg Credit","ADB"],...s]);window.XLSX.utils.book_append_sheet(n,c,"Monthly Summary");const l=e.map((f,w)=>[String(f.global_row_id||f.row_id||w+1),be(f,"date")||"",be(f,"description")||"",be(f,"debit")||"",be(f,"credit")||"",be(f,"balance")||""]),d=window.XLSX.utils.aoa_to_sheet([["#","Date","Description","Debit","Credit","Balance"],...l]);window.XLSX.utils.book_append_sheet(n,d,"Transactions");const u=b?String(b).slice(0,8):"export";if(window.XLSX.writeFile(n,`statement_${u}.xlsx`),v==="credit_evaluator"&&m&&m.id)try{await Bi()}catch{}}function ns(){return`${(rt&&rt.name?rt.name:"statement").replace(/\.pdf$/i,"").replace(/[^a-zA-Z0-9-_]+/g,"_").replace(/^_+|_+$/g,"")||"statement"}_export.pdf`}function Fe(e,t=!1){const n=typeof e=="number"?e:Xe(String(e||""));if(!Number.isFinite(n))return xe(String(e||"-").trim()||"-");const a=new Intl.NumberFormat("en-US",{minimumFractionDigits:2,maximumFractionDigits:2}).format(Math.abs(n));return`${t?"":n<0?"-":""}${a}`}function as(e,t=!1){const n=typeof e=="number"?e:Xe(String(e||""));if(!Number.isFinite(n))return xe(String(e||"-").trim()||"-");const a=new Intl.NumberFormat("en-US",{minimumFractionDigits:2,maximumFractionDigits:2}).format(Math.abs(n));return`${t?"":n<0?"-":""}${a}`}function xe(e){return String(e||"").replace(/₱/g,"PHP ").replace(/[^\x20-\x7E\n\r\t]/g," ").replace(/\s+/g," ").trim()}function rs(e){return new Promise(t=>setTimeout(t,e))}function is(){if(typeof Te.showPicker=="function"){Te.showPicker();return}Te.click()}ir();pa();q();"scrollRestoration"in history&&(history.scrollRestoration="manual");window.scrollTo(0,0);
